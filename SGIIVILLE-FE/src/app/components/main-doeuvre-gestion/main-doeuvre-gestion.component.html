<!-- ============================================
     GESTION MAIN-D'≈íUVRE - T6 COMPLET
     ============================================ -->

<div class="main-doeuvre-gestion">
  <!-- HEADER -->
  <header class="gestion-header">
    <div>
      <h1>üë∑ Gestion des Fiches de Main-d'≈íuvre</h1>
      <p style="margin: var(--space-2) 0 0 0; color: var(--neutral-700); font-size: var(--body-normal);">
        Cr√©er et g√©rer les fiches de main-d'≈ìuvre avec comptes utilisateurs. Les agents peuvent se connecter pour consulter leurs interventions.
      </p>
    </div>
    <div>
      <button class="btn-primary" (click)="creerNouveau()" [attr.aria-label]="'Cr√©er une nouvelle fiche'">
        ‚ûï Nouvelle Fiche
      </button>
      <button class="btn-secondary" (click)="retour()" [attr.aria-label]="'Retour au dashboard'">
        ‚Üê Retour
      </button>
    </div>
  </header>

  <!-- Filtres et Recherche -->
  <div class="filters-section">
    <h3 style="margin: 0 0 var(--space-4) 0; font-size: var(--h3-size); font-weight: var(--h3-weight);">
      üîç Recherche et Filtres
    </h3>
    
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="recherche" 
        (input)="appliquerFiltres()"
        placeholder="Rechercher par nom, pr√©nom, matricule, comp√©tence..."
        [attr.aria-label]="'Rechercher une fiche'">
    </div>
    
    <div class="filters">
      <select 
        [(ngModel)]="filtreCompetence" 
        (change)="loadMainDOeuvre()"
        [attr.aria-label]="'Filtrer par comp√©tence'">
        <option value="">Toutes les comp√©tences</option>
        <option *ngFor="let comp of competencesDisponibles" [value]="comp">{{comp}}</option>
      </select>
      
      <select 
        [(ngModel)]="filtreDisponibilite" 
        (change)="loadMainDOeuvre()"
        [attr.aria-label]="'Filtrer par disponibilit√©'">
        <option value="">Toutes les disponibilit√©s</option>
        <option value="DISPONIBLE">‚úÖ Disponible</option>
        <option value="OCCUPE">üîÑ Occup√©</option>
        <option value="CONFLIT">‚ö†Ô∏è Conflit d'horaires</option>
        <option value="EN_CONGE">üèñÔ∏è En cong√©</option>
        <option value="ABSENT">üè• Absent</option>
        <option value="HORS_HABILITATION">‚õî Hors habilitation</option>
      </select>
    </div>
  </div>

  <!-- Formulaire cr√©ation/√©dition -->
  <div *ngIf="isCreating || isEditing" class="form-modal">
    <h2>{{isCreating ? '‚ûï Nouvelle Fiche de Main-d\'≈íuvre' : '‚úèÔ∏è Modifier Fiche'}}</h2>
    <p class="form-description" *ngIf="isCreating">
      Cr√©ez une fiche de main-d'≈ìuvre avec un compte utilisateur. L'agent pourra se connecter 
      pour consulter ses interventions. <strong>L'email est obligatoire</strong> pour cr√©er le compte.
    </p>
    <p class="form-description" *ngIf="isEditing">
      Modifiez les informations de la fiche de main-d'≈ìuvre.
    </p>
    
    <form (ngSubmit)="sauvegarder()">
      <div class="form-grid">
        <div>
          <label>Nom *</label>
          <input 
            type="text" 
            [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.nom" 
            name="nom"
            required
            placeholder="Nom de famille">
        </div>
        
        <div>
          <label>Pr√©nom</label>
          <input 
            type="text" 
            [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.prenom" 
            name="prenom"
            placeholder="Pr√©nom">
        </div>
        
        <div>
          <label>Matricule Interne</label>
          <input 
            type="text" 
            [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.matricule" 
            name="matricule"
            placeholder="Ex: MO-001">
        </div>
        
        <div>
          <label>CIN *</label>
          <input 
            type="text" 
            [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.cin" 
            name="cin"
            required
            placeholder="Num√©ro CIN">
        </div>
        
        <div>
          <label>T√©l√©phone *</label>
          <input 
            type="tel" 
            [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.telephone" 
            name="telephone"
            required
            placeholder="+216 XX XXX XXX">
        </div>
        
        <div>
          <label>M√©tier</label>
          <input 
            type="text" 
            [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.metier" 
            name="metier"
            placeholder="Ex: √âlectricien, Plombier, Ma√ßon...">
        </div>
        
        <div>
          <label>Email <span *ngIf="isCreating" class="required-asterisk">*</span></label>
          <input 
            type="email" 
            [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.email" 
            name="email"
            [required]="isCreating"
            placeholder="email@example.com">
          <p class="form-hint-small" *ngIf="isCreating">
            ‚ö†Ô∏è Obligatoire : Un compte utilisateur sera cr√©√© avec cet email. Le mot de passe par d√©faut sera le matricule ou le CIN.
          </p>
        </div>

        <div>
          <label>Photo (URL ou chemin)</label>
          <input 
            type="text" 
            [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.photoPath" 
            name="photoPath"
            placeholder="/photos/agent.jpg ou URL">
          <p class="form-hint-small">Optionnel : Chemin vers la photo de l'agent</p>
        </div>
      </div>

      <!-- Comp√©tences -->
      <div class="form-section">
        <label>Comp√©tences</label>
        <p class="form-hint">S√©lectionnez les comp√©tences de ce membre</p>
        <div class="checkbox-group">
          <label *ngFor="let comp of competencesDisponibles" class="checkbox-label">
            <input 
              type="checkbox" 
              [checked]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.competences.includes(comp)"
              (change)="toggleCompetence(comp, isCreating)">
            <span>{{comp}}</span>
          </label>
        </div>
      </div>

      <!-- Habilitations avec dates d'expiration -->
      <div class="form-section">
        <label>Habilitations</label>
        <p class="form-hint">S√©lectionnez les habilitations et d√©finissez leurs dates d'expiration</p>
        <div class="habilitations-list">
          <div *ngFor="let hab of habilitationsDisponibles" class="habilitation-item">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                [checked]="((isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.habilitations || []).includes(hab)"
                (change)="toggleHabilitation(hab, isCreating)">
              <span>{{hab}}</span>
            </label>
            <div *ngIf="((isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.habilitations || []).includes(hab)" 
                 class="habilitation-date">
              <label>Date d'expiration:</label>
              <input 
                type="date"
                [value]="getHabilitationExpiration(hab, isCreating)"
                (change)="updateHabilitationExpiration(hab, $any($event.target).value, isCreating)"
                placeholder="Date d'expiration">
            </div>
          </div>
        </div>
      </div>

      <!-- Horaires de travail -->
      <div class="form-section">
        <label>Horaires de Travail</label>
        <p class="form-hint">D√©finissez les horaires de travail pour chaque jour (format: 08:00-17:00)</p>
        <div class="horaires-grid">
          <div *ngFor="let jour of joursSemaine" class="horaire-item">
            <label>{{jour}}</label>
            <input 
              type="text" 
              [value]="getHorairesTravail(jour, isCreating)"
              (change)="updateHorairesTravail(jour, $any($event.target).value, isCreating)"
              placeholder="08:00-17:00"
              pattern="\d{2}:\d{2}-\d{2}:\d{2}">
          </div>
        </div>
      </div>

      <!-- Cong√©s -->
      <div class="form-section">
        <label>Cong√©s</label>
        <p class="form-hint">Ajoutez les dates de cong√©s de l'agent</p>
        <div class="dates-list">
          <div class="date-input-group">
            <input 
              type="date" 
              [(ngModel)]="nouveauConge"
              name="nouveauConge"
              placeholder="Date de cong√©">
            <button type="button" class="btn-small" (click)="ajouterConge(isCreating)">
              ‚ûï Ajouter
            </button>
          </div>
          <div *ngIf="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.conges && (isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.conges!.length > 0" 
               class="dates-tags">
            <span *ngFor="let conge of (isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.conges" 
                  class="date-tag">
              {{conge | date:'shortDate'}}
              <button type="button" class="btn-remove" (click)="retirerConge(conge, isCreating)">‚úï</button>
            </span>
          </div>
        </div>
      </div>

      <!-- Absences -->
      <div class="form-section">
        <label>Absences</label>
        <p class="form-hint">Ajoutez les dates d'absences (maladie, permission, etc.)</p>
        <div class="dates-list">
          <div class="date-input-group">
            <input 
              type="date" 
              [(ngModel)]="nouvelleAbsence"
              name="nouvelleAbsence"
              placeholder="Date d'absence">
            <button type="button" class="btn-small" (click)="ajouterAbsence(isCreating)">
              ‚ûï Ajouter
            </button>
          </div>
          <div *ngIf="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.absences && (isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.absences!.length > 0" 
               class="dates-tags">
            <span *ngFor="let absence of (isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.absences" 
                  class="date-tag">
              {{absence | date:'shortDate'}}
              <button type="button" class="btn-remove" (click)="retirerAbsence(absence, isCreating)">‚úï</button>
            </span>
          </div>
        </div>
      </div>

      <!-- Disponibilit√© initiale -->
      <div class="form-section">
        <label>Statut Initial</label>
        <p class="form-hint">Le statut sera mis √† jour automatiquement lors des affectations</p>
        <select 
          [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.disponibilite" 
          name="disponibilite"
          class="select-disponibilite">
          <option value="DISPONIBLE">‚úÖ Disponible</option>
          <option value="OCCUPE">üîÑ Occup√©</option>
          <option value="CONFLIT">‚ö†Ô∏è Conflit d'horaires</option>
          <option value="EN_CONGE">üèñÔ∏è En cong√©</option>
          <option value="ABSENT">üè• Absent</option>
          <option value="HORS_HABILITATION">‚õî Hors habilitation</option>
        </select>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="annuler()">Annuler</button>
        <button type="submit" class="btn-success">üíæ Enregistrer</button>
      </div>
    </form>
  </div>

  <!-- Liste des fiches -->
  <div class="main-doeuvre-list">
    <div *ngFor="let md of mainDOeuvreFiltree" class="main-doeuvre-card">
      <!-- Card Header -->
      <div class="card-header">
        <div class="header-left-with-photo">
          <div *ngIf="md.photoPath" class="agent-photo">
            <img [src]="md.photoPath" [alt]="md.nom + ' ' + md.prenom" onerror="this.style.display='none'">
          </div>
          <div>
            <h3>{{md.nom}} {{md.prenom || ''}}</h3>
            <p style="margin: 4px 0 0 0; font-size: var(--body-small); color: var(--neutral-500);">
              ID Interne: #{{md.id}} | Matricule: {{md.matricule || 'Non renseign√©'}}
            </p>
          </div>
        </div>
        <span class="badge" [class]="'disponibilite-' + (md.disponibilite || 'DISPONIBLE').toLowerCase()">
          {{getDisponibiliteLabel(md.disponibilite)}}
        </span>
      </div>
      
      <!-- Card Body -->
      <div class="card-body">
        <div class="info-grid-card">
          <div class="info-item-card" *ngIf="md.cin">
            <strong>CIN:</strong>
            <span>{{md.cin}}</span>
          </div>
          
          <div class="info-item-card" *ngIf="md.telephone">
            <strong>T√©l√©phone:</strong>
            <span>{{md.telephone}}</span>
          </div>
          
          <div class="info-item-card" *ngIf="md.metier">
            <strong>M√©tier:</strong>
            <span>{{md.metier}}</span>
          </div>
        </div>
        
        <!-- Comp√©tences -->
        <div *ngIf="md.competences && md.competences.length > 0" class="tags">
          <strong>Comp√©tences:</strong>
          <div class="tags-list">
            <span *ngFor="let comp of md.competences" class="tag tag-competence">{{comp}}</span>
          </div>
        </div>
        
        <!-- Habilitations avec dates d'expiration -->
        <div *ngIf="md.habilitations && md.habilitations.length > 0" class="tags">
          <strong>Habilitations:</strong>
          <div class="tags-list">
            <span *ngFor="let hab of md.habilitations" 
                  class="tag tag-habilitation"
                  [class.expired]="isHabilitationExpiree(hab, md)">
              {{hab}}
              <span *ngIf="md.habilitationsExpiration && md.habilitationsExpiration[hab]" 
                    class="expiration-date">
                (Exp: {{md.habilitationsExpiration[hab] | date:'shortDate'}})
              </span>
              <span *ngIf="isHabilitationExpiree(hab, md)" class="expired-badge">‚ö†Ô∏è Expir√©e</span>
            </span>
          </div>
        </div>

        <!-- Email -->
        <div *ngIf="md.email" class="info-item-card">
          <strong>Email:</strong>
          <span>{{md.email}}</span>
          <span class="badge-compte" style="margin-left: 0.5rem; background: var(--success-500); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
            ‚úì Compte cr√©√©
          </span>
        </div>

        <!-- Horaires de travail -->
        <div *ngIf="md.horairesTravail && hasHoraires(md.horairesTravail)" class="horaires-display">
          <strong>Horaires de travail:</strong>
          <div class="horaires-list">
            <ng-container *ngFor="let jour of joursSemaine">
              <span *ngIf="md.horairesTravail && md.horairesTravail[jour]"
                    class="horaire-badge">
                {{jour}}: {{md.horairesTravail[jour]}}
              </span>
            </ng-container>
          </div>
        </div>

        <!-- Cong√©s et absences -->
        <div *ngIf="(md.conges && md.conges.length > 0) || (md.absences && md.absences.length > 0)" class="dates-display">
          <div *ngIf="md.conges && md.conges.length > 0" class="dates-group">
            <strong>Cong√©s:</strong>
            <div class="dates-tags">
              <span *ngFor="let conge of md.conges" class="date-tag conge">{{conge | date:'shortDate'}}</span>
            </div>
          </div>
          <div *ngIf="md.absences && md.absences.length > 0" class="dates-group">
            <strong>Absences:</strong>
            <div class="dates-tags">
              <span *ngFor="let absence of md.absences" class="date-tag absence">{{absence | date:'shortDate'}}</span>
            </div>
          </div>
        </div>

        <!-- Historique -->
        <div *ngIf="md.historiqueInterventionIds && md.historiqueInterventionIds.length > 0" class="historique-info">
          <strong>Interventions r√©alis√©es:</strong>
          <span class="historique-count">{{md.historiqueInterventionIds.length}} intervention(s)</span>
        </div>
      </div>

      <!-- Card Actions -->
      <div class="card-actions">
        <button class="btn-primary" (click)="editer(md)" [attr.aria-label]="'Modifier la fiche de ' + md.nom">
          ‚úèÔ∏è Modifier
        </button>
        <button class="btn-info" (click)="voirHistorique(md)" [attr.aria-label]="'Voir l\'historique de ' + md.nom">
          üìä Historique
        </button>
        <button class="btn-danger" (click)="archiver(md)" [attr.aria-label]="'Archiver la fiche de ' + md.nom">
          üóÑÔ∏è Archiver
        </button>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="mainDOeuvreFiltree.length === 0" class="empty-state">
      <div style="font-size: 4rem; margin-bottom: var(--space-4); opacity: 0.5;">üë∑</div>
      <p>Aucune fiche de main-d'≈ìuvre trouv√©e</p>
      <p style="font-size: var(--body-small); color: var(--neutral-500); margin-top: var(--space-2);">
        Cr√©ez votre premi√®re fiche ou modifiez vos filtres de recherche
      </p>
      <button class="btn-primary" (click)="creerNouveau()" style="margin-top: var(--space-4);">
        ‚ûï Cr√©er une fiche
      </button>
    </div>
  </div>

  <!-- Modal Historique -->
  <div *ngIf="showHistorique && selectedMainDOeuvreForHistorique" class="modal-overlay" (click)="fermerHistorique()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>üìä Historique des Interventions</h2>
        <button class="btn-close" (click)="fermerHistorique()">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="agent-info">
          <strong>{{selectedMainDOeuvreForHistorique.nom}} {{selectedMainDOeuvreForHistorique.prenom || ''}}</strong>
          <span *ngIf="selectedMainDOeuvreForHistorique.matricule"> - Matricule: {{selectedMainDOeuvreForHistorique.matricule}}</span>
        </p>
        
        <div *ngIf="historique.length === 0" class="empty-state">
          <p>Aucune intervention enregistr√©e</p>
        </div>
        
        <div *ngIf="historique.length > 0" class="historique-list">
          <!-- Statistiques globales -->
          <div class="historique-stats">
            <div class="stat-item">
              <strong>Total interventions:</strong>
              <span>{{historique.length}}</span>
            </div>
            <div class="stat-item">
              <strong>Temps total travaill√©:</strong>
              <span>{{calculerTempsTotal()}} minutes ({{formatTempsTotal()}})</span>
            </div>
            <div class="stat-item">
              <strong>Interventions termin√©es:</strong>
              <span>{{compterTerminees()}}</span>
            </div>
          </div>

          <!-- Liste des interventions -->
          <div *ngFor="let hist of historique" class="historique-item">
            <div class="historique-header">
              <h4>Intervention #{{hist.interventionId}}</h4>
              <span class="badge" [class]="'etat-' + (hist.etat || 'INCONNU').toLowerCase()">{{hist.etat || 'INCONNU'}}</span>
            </div>
            <p class="historique-description">{{hist.description}}</p>
            <div class="historique-details">
              <div class="detail-item">
                <strong>Date d√©but:</strong>
                <span>{{hist.dateDebut | date:'short'}}</span>
              </div>
              <div *ngIf="hist.dateFin" class="detail-item">
                <strong>Date fin:</strong>
                <span>{{hist.dateFin | date:'short'}}</span>
              </div>
              <div class="detail-item">
                <strong>Temps pass√©:</strong>
                <span>{{hist.tempsPasseMinutes}} minutes ({{formatTemps(hist.tempsPasseMinutes)}})</span>
              </div>
              <div *ngIf="hist.competencesUtilisees && hist.competencesUtilisees.length > 0" class="detail-item">
                <strong>Comp√©tences utilis√©es:</strong>
                <div class="tags-list">
                  <span *ngFor="let comp of hist.competencesUtilisees" class="tag tag-competence">{{comp}}</span>
                </div>
              </div>
              <div *ngIf="hist.resultat" class="detail-item">
                <strong>R√©sultat:</strong>
                <span class="resultat-badge" [class]="'resultat-' + (hist.resultat || 'inconnu').toLowerCase()">{{hist.resultat || 'N/A'}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="fermerHistorique()">Fermer</button>
      </div>
    </div>
  </div>
</div>
