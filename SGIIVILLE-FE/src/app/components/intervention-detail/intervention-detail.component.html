<div class="intervention-detail" *ngIf="intervention">
  <header class="detail-header">
    <h1>Intervention #{{intervention.id}}</h1>
    <button class="btn-secondary" (click)="retour()">Retour</button>
  </header>

  <!-- VUE SIMPLIFI√âE POUR MAIN-D'≈íUVRE -->
  <div class="detail-content" *ngIf="isMainDOeuvre">
    <!-- Informations principales -->
    <section class="info-section">
      <h2>üìã Informations de l'Intervention</h2>
      <div class="info-grid">
        <div class="info-item">
          <strong>Description:</strong>
          <p>{{intervention.description || 'Non sp√©cifi√©e'}}</p>
        </div>
        <div class="info-item">
          <strong>Type:</strong>
          <span>{{intervention.typeIntervention || 'Non sp√©cifi√©'}}</span>
        </div>
        <div class="info-item">
          <strong>Priorit√©:</strong>
          <span class="badge" [class]="'priorite-' + (intervention.priorite || 'NORMALE').toLowerCase()">
            {{intervention.priorite}}
          </span>
        </div>
        <div class="info-item">
          <strong>√âtat:</strong>
          <span class="badge" [class]="'etat-' + (intervention.etat || 'EN_ATTENTE').toLowerCase()">
            {{intervention.etat}}
          </span>
        </div>
        <div class="info-item" *ngIf="intervention.datePlanifiee">
          <strong>Date pr√©vue:</strong>
          <span>{{intervention.datePlanifiee | date:'dd/MM/yyyy'}}</span>
        </div>
        <div class="info-item" *ngIf="intervention.dateDebut">
          <strong>Date d√©but:</strong>
          <span>{{intervention.dateDebut | date:'dd/MM/yyyy HH:mm'}}</span>
        </div>
      </div>
    </section>

    <!-- Mes T√¢ches (uniquement celles assign√©es √† cette main-d'≈ìuvre) -->
    <section class="taches-section">
      <div class="section-header">
        <h2>üìã Mes T√¢ches</h2>
        <p class="section-subtitle">T√¢ches qui vous sont assign√©es pour cette intervention</p>
      </div>

      <!-- Liste des t√¢ches -->
      <div class="taches-list">
        <div *ngIf="taches.length === 0" class="empty-taches">
          <p>üì≠ Aucune t√¢che assign√©e pour le moment</p>
          <p class="hint">Le technicien vous assignera des t√¢ches prochainement.</p>
        </div>

        <div *ngFor="let tache of taches" class="tache-card" [class]="getEtatTacheClass(tache.etat)">
          <div class="tache-header">
            <div class="tache-title">
              <span class="tache-ordre">#{{tache.ordre || tache.id}}</span>
              <h3>{{tache.libelle}}</h3>
            </div>
            <span class="badge-etat" [class]="getEtatTacheClass(tache.etat)">
              {{getEtatTacheLabel(tache.etat)}}
            </span>
          </div>

          <div class="tache-body" *ngIf="tache.description">
            <p>{{tache.description}}</p>
          </div>

          <div class="tache-info">
            <div class="info-item" *ngIf="tache.dateDebut">
              <strong>D√©but√©e le:</strong>
              <span>{{tache.dateDebut | date:'dd/MM/yyyy HH:mm'}}</span>
            </div>
            <div class="info-item" *ngIf="tache.dateFin">
              <strong>Termin√©e le:</strong>
              <span>{{tache.dateFin | date:'dd/MM/yyyy HH:mm'}}</span>
            </div>
            <div class="info-item" *ngIf="tache.tempsPasseMinutes">
              <strong>Temps pass√©:</strong>
              <span>{{tache.tempsPasseMinutes}} minutes</span>
            </div>
            <div class="info-item" *ngIf="tache.commentaireMainDOeuvre">
              <strong>Votre commentaire:</strong>
              <p>{{tache.commentaireMainDOeuvre}}</p>
            </div>
            <div class="info-item" *ngIf="tache.commentaireTechnicien">
              <strong>Commentaire du technicien:</strong>
              <p>{{tache.commentaireTechnicien}}</p>
            </div>
          </div>

          <div class="tache-actions">
            <!-- Commencer la t√¢che -->
            <button 
              *ngIf="tache.etat === 'A_FAIRE'" 
              class="btn-primary"
              (click)="commencerTacheMainDOeuvre(tache)">
              ‚ñ∂Ô∏è Commencer la t√¢che
            </button>

            <!-- Terminer la t√¢che -->
            <button 
              *ngIf="tache.etat === 'EN_COURS'" 
              class="btn-success"
              (click)="ouvrirTerminerTacheMainDOeuvre(tache)">
              ‚úÖ Terminer la t√¢che
            </button>

            <!-- T√¢che termin√©e, en attente de v√©rification -->
            <div *ngIf="tache.etat === 'TERMINEE' && !tache.verifiee" class="tache-en-attente">
              <p class="info-text">‚è≥ T√¢che termin√©e, en attente de v√©rification par le technicien</p>
            </div>

            <!-- T√¢che v√©rifi√©e -->
            <div *ngIf="tache.verifiee" class="tache-verifiee">
              <p class="success-text">‚úÖ T√¢che v√©rifi√©e et valid√©e par le technicien</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal pour terminer la t√¢che -->
      <div *ngIf="selectedTacheForTerminer" class="modal-terminer-tache">
        <div class="modal-content">
          <h3>Terminer la t√¢che: {{selectedTacheForTerminer.libelle}}</h3>
          <div class="form-group">
            <label>Commentaire (optionnel)</label>
            <textarea 
              [(ngModel)]="terminerTacheRequest.commentaire" 
              placeholder="Ajoutez un commentaire sur votre travail..."></textarea>
          </div>
          <div class="form-group">
            <label>Temps pass√© (minutes, optionnel)</label>
            <input 
              type="number" 
              [(ngModel)]="terminerTacheRequest.tempsPasseMinutes" 
              placeholder="Ex: 120">
          </div>
          <div class="modal-actions">
            <button class="btn-secondary" (click)="selectedTacheForTerminer = null">Annuler</button>
            <button class="btn-success" (click)="terminerTacheMainDOeuvre()">‚úÖ Terminer</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- VUE COMPL√àTE POUR TECHNICIEN -->
  <div class="detail-content" *ngIf="isTechnicien">
    <!-- Informations principales -->
    <section class="info-section">
      <h2>Informations</h2>
      <div class="info-grid">
        <div class="info-item">
          <strong>Description:</strong>
          <p>{{intervention.description || 'Non sp√©cifi√©e'}}</p>
        </div>
        <div class="info-item">
          <strong>Type:</strong>
          <span>{{intervention.typeIntervention || 'Non sp√©cifi√©'}}</span>
        </div>
        <div class="info-item">
          <strong>Priorit√©:</strong>
          <span class="badge" [class]="'priorite-' + (intervention.priorite || 'NORMALE').toLowerCase()">
            {{intervention.priorite}}
          </span>
        </div>
        <div class="info-item">
          <strong>√âtat:</strong>
          <span class="badge" [class]="'etat-' + (intervention.etat || 'EN_ATTENTE').toLowerCase()">
            {{intervention.etat}}
          </span>
        </div>
        <div class="info-item">
          <strong>Date pr√©vue:</strong>
          <span>{{intervention.datePlanifiee | date:'dd/MM/yyyy'}}</span>
        </div>
        <div class="info-item" *ngIf="intervention.dateDebut">
          <strong>Date d√©but:</strong>
          <span>{{intervention.dateDebut | date:'dd/MM/yyyy HH:mm'}}</span>
        </div>
        <div class="info-item" *ngIf="intervention.tempsPasseMinutes">
          <strong>Temps pass√©:</strong>
          <span>{{intervention.tempsPasseMinutes}} minutes</span>
        </div>
        <div class="info-item">
          <strong>Budget:</strong>
          <span>{{intervention.budget}} DT</span>
        </div>
      </div>
    </section>

    <!-- Actions d'intervention (uniquement pour technicien) -->
    <section class="actions-section" *ngIf="isTechnicien">
      <h2>Actions</h2>
      <div class="action-buttons">
        <button *ngIf="intervention.etat === 'EN_ATTENTE'" 
                class="btn-primary" 
                (click)="commencer()">
          Commencer l'intervention
        </button>
        <button *ngIf="intervention.etat === 'EN_COURS'" 
                class="btn-warning" 
                (click)="mettreEnPause()">
          Mettre en pause
        </button>
        <button *ngIf="intervention.etat === 'SUSPENDUE'" 
                class="btn-primary" 
                (click)="reprendre()">
          Reprendre
        </button>
        <button *ngIf="intervention.etat === 'EN_COURS'" 
                class="btn-success" 
                (click)="terminer()">
          Terminer
        </button>
        <button class="btn-secondary" 
                (click)="showUpdateEtat = !showUpdateEtat">
          Mettre √† jour l'√©tat
        </button>
      </div>

      <!-- Formulaire mise √† jour √©tat -->
      <div *ngIf="showUpdateEtat" class="update-etat-form">
        <h3>Mettre √† jour l'√©tat</h3>
        <select [(ngModel)]="updateEtatRequest.nouvelEtat">
          <option value="EN_ATTENTE">EN_ATTENTE</option>
          <option value="EN_COURS">EN_COURS</option>
          <option value="SUSPENDUE">SUSPENDUE</option>
          <option value="TERMINEE">TERMINEE</option>
        </select>
        <input type="number" 
               [(ngModel)]="updateEtatRequest.tempsPasseMinutes" 
               placeholder="Temps pass√© (minutes)">
        <textarea [(ngModel)]="updateEtatRequest.commentaire" 
                  placeholder="Commentaire"></textarea>
        <button class="btn-primary" (click)="updateEtat()">Enregistrer</button>
      </div>
    </section>

    <!-- üìò 3.1 - Gestion main-d'≈ìuvre affect√©e -->
    <section class="main-doeuvre-section">
      <div class="section-header">
        <h2>üë∑ Gestion de la Main-d'≈íuvre</h2>
        <a routerLink="/technicien/main-doeuvre" class="link-manage">
          üìã G√©rer toutes les fiches
        </a>
      </div>

      <!-- Liste de main-d'≈ìuvre affect√©e (T3.1) -->
      <div class="affectee-section">
        <h3>üìò Main-d'≈íuvre Affect√©e √† cette Intervention</h3>
        <!-- Debug info (√† retirer en production) -->
        <div style="font-size: 0.8em; color: #666; margin-bottom: 10px; padding: 8px; background: #f0f0f0; border-radius: 4px;" *ngIf="intervention">
          <strong>üîç Debug:</strong><br>
          ‚Ä¢ IDs dans intervention: <strong>{{intervention.mainDOeuvreIds ? intervention.mainDOeuvreIds.join(', ') : 'aucun'}}</strong><br>
          ‚Ä¢ Nombre de main-d'≈ìuvre charg√©es: <strong>{{mainDOeuvreAffectee.length}}</strong><br>
          <span *ngIf="mainDOeuvreAffectee.length > 0">
            ‚Ä¢ Main-d'≈ìuvre charg√©es: 
            <span *ngFor="let md of mainDOeuvreAffectee; let i = index">
              {{md.nom}} {{md.prenom || ''}} (ID: {{md.id}})<span *ngIf="i < mainDOeuvreAffectee.length - 1">, </span>
            </span>
          </span>
        </div>
        <div *ngIf="mainDOeuvreAffectee.length > 0" class="main-doeuvre-list-affectee">
          <div *ngFor="let md of mainDOeuvreAffectee" class="main-doeuvre-card-affectee">
            <div class="card-content">
              <div class="card-header-main">
                <div>
                  <h4>{{md.nom}} {{md.prenom || ''}}</h4>
                  <p class="id-interne">ID Interne: #{{md.id}}</p>
                </div>
                <span class="badge-disponibilite" [class]="'status-' + (md.disponibilite || 'DISPONIBLE').toLowerCase()">
                  {{getDisponibiliteLabel(md.disponibilite)}}
                </span>
              </div>
              
              <div class="card-details">
                <div class="detail-item" *ngIf="md.matricule">
                  <strong>Matricule:</strong> {{md.matricule}}
                </div>
                <div class="detail-item" *ngIf="md.metier">
                  <strong>M√©tier:</strong> {{md.metier}}
                </div>
                
                <div class="detail-item" *ngIf="md.competences && md.competences.length > 0">
                  <strong>Comp√©tences:</strong>
                  <div class="tags-list">
                    <span *ngFor="let comp of md.competences" class="tag-competence">{{comp}}</span>
                  </div>
                </div>
                
                <div class="detail-item" *ngIf="md.habilitations && md.habilitations.length > 0">
                  <strong>Habilitations:</strong>
                  <div class="tags-list">
                    <span *ngFor="let hab of md.habilitations" class="tag-habilitation">{{hab}}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <button 
              class="btn-danger btn-desaffecter" 
              (click)="desaffecterMainDOeuvre(md.id)"
              [attr.aria-label]="'D√©saffecter ' + md.nom + ' ' + md.prenom">
              üóëÔ∏è D√©saffecter
            </button>
          </div>
        </div>
        
        <div *ngIf="mainDOeuvreAffectee.length === 0" class="empty-main-doeuvre">
          <div class="empty-icon">üë∑</div>
          <p>Aucune main-d'≈ìuvre affect√©e √† cette intervention</p>
        </div>
      </div>

      <!-- üìô 3.2 - Ajouter / Affecter de la main-d'≈ìuvre (uniquement pour technicien) -->
      <div class="affecter-section" *ngIf="isTechnicien">
        <div class="section-header-with-action">
          <div>
            <h3>üìô Affecter de la Main-d'≈íuvre</h3>
            <p class="section-description">
              S√©lectionnez des membres disponibles pour cette intervention. 
              Le syst√®me v√©rifie automatiquement la disponibilit√©, les comp√©tences, 
              les habilitations et les conflits d'horaires.
            </p>
          </div>
          <button 
            *ngIf="selectedMainDOeuvreForCalendar"
            class="btn-calendar-toggle"
            (click)="hideAvailabilityCalendar()">
            ‚úï Fermer Calendrier
          </button>
        </div>

        <!-- CALENDRIER DE DISPONIBILIT√â -->
        <div *ngIf="showAvailabilityCalendar && selectedMainDOeuvreForCalendar" class="availability-calendar-container">
          <app-availability-calendar
            [mainDOeuvre]="selectedMainDOeuvreForCalendar"
            [currentIntervention]="intervention"
            [allInterventions]="allInterventionsForCalendar"
            (slotSelected)="onSlotSelected($event)">
          </app-availability-calendar>
        </div>

        <!-- Filtres pour la recherche -->
        <div class="filters-main-doeuvre">
          <input 
            type="text" 
            [(ngModel)]="rechercheMainDOeuvre"
            (input)="filtrerMainDOeuvreDisponible()"
            placeholder="Rechercher par nom, matricule, comp√©tence..."
            class="search-input">
          
          <select 
            [(ngModel)]="filtreCompetenceMainDOeuvre"
            (change)="filtrerMainDOeuvreDisponible()"
            class="filter-select">
            <option value="">Toutes les comp√©tences</option>
            <option *ngFor="let comp of competencesDisponibles" [value]="comp">{{comp}}</option>
          </select>
          
          <select 
            [(ngModel)]="filtreDisponibiliteMainDOeuvre"
            (change)="filtrerMainDOeuvreDisponible()"
            class="filter-select">
            <option value="">Toutes les disponibilit√©s</option>
            <option value="DISPONIBLE">‚úÖ Disponible</option>
            <option value="OCCUPE">üîÑ Occup√©</option>
            <option value="EN_CONGE">üèñÔ∏è En cong√©</option>
            <option value="ABSENT">üè• Absent</option>
          </select>
          
          <select 
            [(ngModel)]="filtreHabilitationMainDOeuvre"
            (change)="filtrerMainDOeuvreDisponible()"
            class="filter-select">
            <option value="">Toutes les habilitations</option>
            <option *ngFor="let hab of habilitationsDisponibles" [value]="hab">{{hab}}</option>
          </select>
        </div>

        <!-- S√©lection multiple -->
        <div *ngIf="mainDOeuvreListeFiltree.length > 0" class="selection-multiple-actions">
          <button 
            class="btn-primary"
            (click)="affecterSelectionMultiple()"
            [disabled]="selectedMainDOeuvreIds.length === 0">
            ‚ûï Affecter {{selectedMainDOeuvreIds.length > 0 ? '(' + selectedMainDOeuvreIds.length + ')' : ''}} s√©lectionn√©(s)
          </button>
          <button 
            class="btn-secondary"
            (click)="selectedMainDOeuvreIds = []"
            *ngIf="selectedMainDOeuvreIds.length > 0">
            ‚úï Tout d√©s√©lectionner
          </button>
        </div>

        <!-- Liste des membres disponibles -->
        <div *ngIf="mainDOeuvreListeFiltree.length > 0" class="main-doeuvre-available">
          <div *ngFor="let md of mainDOeuvreListeFiltree" 
               class="main-doeuvre-card-available"
               [class.selected]="isSelected(md.id)">
            <div class="card-content">
              <!-- Checkbox pour s√©lection multiple -->
              <div class="selection-checkbox">
                <input 
                  type="checkbox"
                  [checked]="isSelected(md.id)"
                  (change)="toggleSelectionMainDOeuvre(md.id)"
                  [attr.aria-label]="'S√©lectionner ' + md.nom + ' ' + md.prenom">
              </div>
              <div class="card-header-main">
                <div>
                  <h4>{{md.nom}} {{md.prenom || ''}}</h4>
                  <p class="id-interne">ID Interne: #{{md.id}}</p>
                </div>
                <span class="badge-disponibilite status-disponible">
                  {{getDisponibiliteLabel(md.disponibilite)}}
                </span>
              </div>
              
              <div class="card-details">
                <div class="detail-item" *ngIf="md.matricule">
                  <strong>Matricule:</strong> {{md.matricule}}
                </div>
                <div class="detail-item" *ngIf="md.metier">
                  <strong>M√©tier:</strong> {{md.metier}}
                </div>
                
                <div class="detail-item" *ngIf="md.competences && md.competences.length > 0">
                  <strong>Comp√©tences:</strong>
                  <div class="tags-list">
                    <span *ngFor="let comp of md.competences" class="tag-competence">{{comp}}</span>
                  </div>
                </div>
                
                <div class="detail-item" *ngIf="md.habilitations && md.habilitations.length > 0">
                  <strong>Habilitations:</strong>
                  <div class="tags-list">
                    <span *ngFor="let hab of md.habilitations" class="tag-habilitation">{{hab}}</span>
                  </div>
                </div>

                <!-- V√©rifications automatiques -->
                <div class="verifications-auto">
                  <div class="check-item" [class.valid]="md.disponibilite === 'DISPONIBLE'">
                    <span *ngIf="md.disponibilite === 'DISPONIBLE'">‚úÖ</span>
                    <span *ngIf="md.disponibilite !== 'DISPONIBLE'">‚ùå</span>
                    Disponibilit√©: {{getDisponibiliteLabel(md.disponibilite)}}
                  </div>
                  <div class="check-item valid" *ngIf="md.competences && md.competences.length > 0">
                    ‚úÖ Comp√©tences v√©rifi√©es
                  </div>
                  <div class="check-item valid" *ngIf="md.habilitations && md.habilitations.length > 0">
                    ‚úÖ Habilitations v√©rifi√©es
                  </div>
                  <div class="check-item valid">
                    ‚úÖ Pas de conflit d'horaires
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card-actions-main-doeuvre">
              <button 
                class="btn-secondary btn-calendar" 
                (click)="showCalendarForMainDOeuvre(md)"
                [attr.aria-label]="'Voir le calendrier de disponibilit√© de ' + md.nom">
                üìÖ Calendrier
              </button>
              <button 
                class="btn-primary btn-affecter" 
                (click)="affecterMainDOeuvre(md.id)"
                [disabled]="md.disponibilite !== 'DISPONIBLE'"
                [attr.aria-label]="'Affecter ' + md.nom + ' ' + md.prenom + ' √† cette intervention'">
                ‚ûï Affecter
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="mainDOeuvreListeFiltree.length === 0" class="empty-main-doeuvre">
          <div class="empty-icon">üîç</div>
          <p>Aucune main-d'≈ìuvre disponible correspondant aux crit√®res</p>
          <button class="btn-secondary" (click)="creerNouvelleFiche()">
            ‚ûï Cr√©er une nouvelle fiche
          </button>
        </div>
      </div>
    </section>

    <!-- üìã GESTION DES T√ÇCHES -->
    <section class="taches-section">
      <div class="section-header">
        <h2>üìã Gestion des T√¢ches</h2>
        <button *ngIf="isTechnicien" class="btn-primary" (click)="showCreateTache = !showCreateTache">
          {{showCreateTache ? '‚úï Annuler' : '‚ûï Cr√©er une t√¢che'}}
        </button>
      </div>

      <!-- Formulaire de cr√©ation de t√¢che (uniquement pour technicien) -->
      <div *ngIf="showCreateTache && isTechnicien" class="create-tache-form">
        <h3>Nouvelle t√¢che</h3>
        <div class="form-group">
          <label>Libell√© *</label>
          <input type="text" [(ngModel)]="nouvelleTache.libelle" placeholder="Ex: R√©paration du syst√®me √©lectrique">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="nouvelleTache.description" placeholder="Description d√©taill√©e de la t√¢che..."></textarea>
        </div>
        <div class="form-group">
          <label>Assigner imm√©diatement √†</label>
          <select [(ngModel)]="nouvelleTache.mainDOeuvreId">
            <option [value]="undefined">Non assign√©e (assigner plus tard)</option>
            <option *ngFor="let md of mainDOeuvreAffectee" [value]="md.id">
              {{md.nom}} {{md.prenom || ''}}
            </option>
          </select>
        </div>
        <button class="btn-success" (click)="creerTache()">üíæ Cr√©er la t√¢che</button>
      </div>

      <!-- Liste des t√¢ches -->
      <div class="taches-list">
        <div *ngIf="taches.length === 0" class="empty-taches">
          <p>üì≠ Aucune t√¢che cr√©√©e pour cette intervention</p>
          <p class="hint">Cr√©ez des t√¢ches pour diviser le travail et assigner chaque t√¢che √† une main-d'≈ìuvre sp√©cifique.</p>
        </div>

        <div *ngFor="let tache of taches" class="tache-card" [class]="getEtatTacheClass(tache.etat)">
          <div class="tache-header">
            <div class="tache-title">
              <span class="tache-ordre">#{{tache.ordre || tache.id}}</span>
              <h3>{{tache.libelle}}</h3>
            </div>
            <span class="badge-etat" [class]="getEtatTacheClass(tache.etat)">
              {{getEtatTacheLabel(tache.etat)}}
            </span>
          </div>

          <div class="tache-body" *ngIf="tache.description">
            <p>{{tache.description}}</p>
          </div>

          <div class="tache-info">
            <div class="info-item">
              <strong>Assign√©e √†:</strong>
              <span>{{getMainDOeuvreName(tache.mainDOeuvreId)}}</span>
            </div>
            <div class="info-item" *ngIf="tache.dateDebut">
              <strong>D√©but√©e le:</strong>
              <span>{{tache.dateDebut | date:'dd/MM/yyyy HH:mm'}}</span>
            </div>
            <div class="info-item" *ngIf="tache.dateFin">
              <strong>Termin√©e le:</strong>
              <span>{{tache.dateFin | date:'dd/MM/yyyy HH:mm'}}</span>
            </div>
            <div class="info-item" *ngIf="tache.tempsPasseMinutes">
              <strong>Temps pass√©:</strong>
              <span>{{tache.tempsPasseMinutes}} minutes</span>
            </div>
            <div class="info-item" *ngIf="tache.commentaireMainDOeuvre">
              <strong>Commentaire main-d'≈ìuvre:</strong>
              <p>{{tache.commentaireMainDOeuvre}}</p>
            </div>
            <div class="info-item" *ngIf="tache.commentaireTechnicien">
              <strong>Commentaire technicien:</strong>
              <p>{{tache.commentaireTechnicien}}</p>
            </div>
          </div>

          <div class="tache-actions">
            <!-- Assigner si non assign√©e (uniquement pour technicien) -->
            <div *ngIf="!tache.mainDOeuvreId && isTechnicien" class="assign-action">
              <label>Assigner √†:</label>
              <select 
                *ngIf="mainDOeuvreAffectee.length > 0"
                [value]="getSelectedMainDOeuvre(tache.id) || ''"
                (change)="setSelectedMainDOeuvre(tache.id, +$any($event.target).value || undefined)">
                <option value="">S√©lectionner...</option>
                <option *ngFor="let md of mainDOeuvreAffectee" [value]="md.id">
                  {{md.nom}} {{md.prenom || ''}}
                </option>
              </select>
              <p *ngIf="mainDOeuvreAffectee.length === 0" class="warning-text">
                ‚ö†Ô∏è Aucune main-d'≈ìuvre affect√©e √† cette intervention. Veuillez d'abord affecter une main-d'≈ìuvre dans la section ci-dessus.
              </p>
              <button 
                *ngIf="mainDOeuvreAffectee.length > 0"
                class="btn-primary btn-small" 
                (click)="assignerTache(tache)"
                [disabled]="!getSelectedMainDOeuvre(tache.id)">
                Assigner
              </button>
            </div>

            <!-- V√©rifier si termin√©e (uniquement pour technicien) -->
            <button 
              *ngIf="tache.etat === 'TERMINEE' && !tache.verifiee && isTechnicien" 
              class="btn-success"
              (click)="ouvrirVerification(tache)">
              ‚úì V√©rifier
            </button>

            <!-- R√©assigner si √† refaire (uniquement pour technicien) -->
            <div *ngIf="tache.etat === 'A_FAIRE' && tache.verifiee === false && tache.mainDOeuvreId && isTechnicien" class="reassign-action">
              <p class="warning-text">‚ö†Ô∏è T√¢che √† refaire</p>
              <button class="btn-secondary btn-small" (click)="assignerTache(tache, tache.mainDOeuvreId!)">
                R√©assigner
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de v√©rification -->
      <div *ngIf="selectedTacheForVerify" class="modal-verification">
        <div class="modal-content">
          <h3>V√©rifier la t√¢che: {{selectedTacheForVerify.libelle}}</h3>
          <div class="form-group">
            <label>
              <input type="radio" [(ngModel)]="verificationValidee" [value]="true">
              ‚úÖ Valider la t√¢che
            </label>
            <label>
              <input type="radio" [(ngModel)]="verificationValidee" [value]="false">
              ‚ùå Demander √† refaire
            </label>
          </div>
          <div class="form-group">
            <label>Commentaire</label>
            <textarea [(ngModel)]="verificationComment" placeholder="Commentaire de v√©rification..."></textarea>
          </div>
          <div class="modal-actions">
            <button class="btn-secondary" (click)="selectedTacheForVerify = null">Annuler</button>
            <button class="btn-success" (click)="verifierTache()">Valider</button>
          </div>
        </div>
      </div>

      <!-- Bouton terminer intervention (uniquement pour technicien) -->
      <div class="terminer-intervention-section" *ngIf="peutTerminerIntervention() && isTechnicien">
        <div class="info-box">
          <p>‚úÖ Toutes les t√¢ches sont v√©rifi√©es. Vous pouvez maintenant terminer l'intervention.</p>
        </div>
        <button class="btn-success btn-large" (click)="terminerIntervention()">
          ‚úÖ Terminer l'intervention
        </button>
      </div>
    </section>

    <!-- Photos et commentaires (uniquement pour technicien) -->
    <section class="photos-section" *ngIf="isTechnicien">
      <h2>Photos</h2>
      <input type="file" 
             multiple 
             accept="image/*" 
             (change)="onFileSelected($event)">
      <button class="btn-primary" (click)="ajouterPhotos()">Ajouter photos</button>
    </section>

    <section class="commentaires-section" *ngIf="isTechnicien">
      <h2>Commentaires</h2>
      <div *ngIf="intervention.commentaire" class="commentaire-existant">
        <p>{{intervention.commentaire}}</p>
      </div>
      <textarea [(ngModel)]="nouveauCommentaire" 
                placeholder="Ajouter un commentaire..."></textarea>
      <button class="btn-primary" (click)="ajouterCommentaire()">Ajouter</button>
    </section>
  </div>
</div>

