<div class="chef-container">

  <!-- Header Moderne -->
  <header class="header">
    <div class="header-content">
      <h1>ğŸ¯ Espace Chef de Service</h1>
      <p class="subtitle">Gestion intelligente des interventions urbaines â€¢ Tunis 2025</p>
    </div>
    
    <!-- IcÃ´ne notifications -->
    <div class="notification-bell" (click)="toggleNotificationsDropdown()">
      ğŸ””
      <span class="badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
      
      <!-- Dropdown notifications -->
      <div class="notifications-dropdown" *ngIf="showNotificationsDropdown" (click)="$event.stopPropagation()">
        <div class="dropdown-header">
          <h4>Notifications</h4>
          <span class="count">{{ unreadCount }} non lue(s)</span>
        </div>
        <div class="notifications-list">
          <div *ngIf="notifications.length === 0" class="empty-state">
            Aucune notification
          </div>
          <div *ngFor="let notif of notifications" 
               class="notification-item"
               [class.unread]="!notif.readable"
               (click)="markAsRead(notif)">
            <div class="notif-icon">
              {{ notif.readable ? 'ğŸ“¬' : 'ğŸ“­' }}
            </div>
            <div class="notif-content">
              <p class="notif-message">{{ notif.message }}</p>
              <span class="notif-time">{{ formatNotificationDate(notif.createdAt) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Stats Cards Modernes -->
  <div class="stats-grid">
    <div class="stat-card pending" (click)="filtrerDemandes('NON_TRAITEES')">
      <div class="icon">â³</div>
      <div class="info">
        <h3>{{ demandesPendantes }}</h3>
        <p>Demandes en attente</p>
      </div>
    </div>
    <div class="stat-card progress" (click)="openInterventionsModal()">
      <div class="icon">ğŸ”§</div>
      <div class="info">
        <h3>{{ interventionsEnCoursCount }}</h3>
        <p>Interventions en cours</p>
      </div>
    </div>
    <div class="stat-card success" (click)="filtrerDemandes('TRAITEES')">
      <div class="icon">âœ…</div>
      <div class="info">
        <h3>{{ demandesTraitees }}</h3>
        <p>Demandes traitÃ©es</p>
      </div>
    </div>
    <div class="stat-card equip" (click)="openEquipementsModal()">
      <div class="icon">ğŸ› ï¸</div>
      <div class="info">
        <h3>{{ equipements.length }}</h3>
        <p>Ã‰quipements disponibles</p>
      </div>
    </div>
  </div>

  <!-- Section Filtres ModernisÃ©e -->
  <div class="filters-section">
    <h3>ğŸ“Š Filtrer les demandes</h3>
    <div class="filter-buttons">
      <button [class.active]="filtreActif === 'TOUS'" (click)="filtrerDemandes('TOUS')" class="filter-btn">
        ğŸ“‹ Toutes ({{ demandes.length }})
      </button>
      <button [class.active]="filtreActif === 'NON_TRAITEES'" (click)="filtrerDemandes('NON_TRAITEES')" class="filter-btn">
        â³ Non traitÃ©es ({{ demandesPendantes }})
      </button>
      <button [class.active]="filtreActif === 'TRAITEES'" (click)="filtrerDemandes('TRAITEES')" class="filter-btn">
        âœ… TraitÃ©es ({{ demandesTraitees }})
      </button>
    </div>
  </div>

  <!-- Actions Rapides OrganisÃ©es -->
  <div class="quick-actions">
    <h3>âš¡ Actions rapides</h3>
    <div class="actions-grid">
      <button class="action-btn primary" (click)="refreshAll()">
        ğŸ”„ Actualiser
      </button>
      <button class="action-btn danger" (click)="openMapModal()">
        ğŸ—ºï¸ Carte des demandes ({{ demandesPendantes }})
      </button>
      <button class="action-btn info" (click)="openMapInterventionsModal()">
        ğŸ—ºï¸ Carte interventions ({{ interventionsEnCoursCount }})
      </button>
      <button class="action-btn warning" (click)="openTechniciensModal()">
        ğŸ‘· Techniciens ({{ techniciens.length }})
      </button>
      <button class="action-btn success" (click)="openEquipementsModal()">
        ğŸ› ï¸ Ã‰quipements ({{ equipements.length }})
      </button>
      <button class="action-btn info" (click)="openInterventionsModal()">
        ğŸ”§ Interventions ({{ interventions.length }})
      </button>
      <button class="action-btn warning" (click)="openRessourcesModal()">
        ğŸ“¦ MatÃ©riels
      </button>
      <button class="action-btn secondary" (click)="exportReport()">
        ğŸ“¥ Exporter
      </button>
    </div>
  </div>

  <!-- Tableau des Demandes ModernisÃ© -->
  <section class="section">
    <h3>ğŸ“‹ Demandes citoyennes <span style="color: #667eea; font-weight: 700;">({{ demandesFiltrees.length }})</span></h3>
    <div class="table-container">
      <table class="modern-table">
        <thead>
          <tr>
            <th>ğŸ“Œ RÃ©fÃ©rence</th>
            <th>ğŸ“ Description</th>
            <th>ğŸ“… Date</th>
            <th>ğŸ·ï¸ Statut</th>
            <th>ğŸ“ Localisation</th>
            <th>ğŸ“¸ Photos</th>
            <th>âš™ï¸ Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of demandesFiltrees">
            <td><strong style="color: #667eea;">#{{ d.id }}</strong></td>
            <td class="description-cell">
              {{ d.description.length > 60 ? (d.description | slice:0:60) + '...' : d.description }}
            </td>
            <td>{{ d.dateSoumission | date:'dd/MM/yyyy' }}</td>
            <td>
              <span class="status" [ngClass]="getEtatBadgeClass(d.etat)">
                {{ getEtatText(d.etat) }}
              </span>
            </td>
            <td class="location-cell">
              <span *ngIf="d.localisation" style="font-size: 12px;">
                ğŸ“ {{ d.localisation.latitude | number:'1.4' }}, {{ d.localisation.longitude | number:'1.4' }}
              </span>
              <span *ngIf="!d.localisation" class="text-muted">Non prÃ©cisÃ©e</span>
            </td>
            <td style="text-align: center;">
              <span *ngIf="d.photos?.length" 
                    style="background: #e3f2fd; color: #2196f3; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                {{ d.photos?.length }} ğŸ“¸
              </span>
              <span *ngIf="!d.photos?.length" class="text-muted" style="font-size: 12px;">Aucune</span>
            </td>
            <td class="actions-cell">
              <button class="btn-small view" (click)="openDetailModal(d)">ğŸ‘ï¸ DÃ©tails</button>
              <button class="btn-small plan" (click)="planifierDemande(d)"
                      [disabled]="d.etat === 'TRAITEE'">
                {{ d.etat === 'TRAITEE' ? 'âœ… PlanifiÃ©e' : 'ğŸ“… Planifier' }}
              </button>
            </td>
          </tr>
          <tr *ngIf="!demandesFiltrees.length">
            <td colspan="7" class="no-data">
              <div style="padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
                <p>Aucune demande Ã  afficher</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- MODAL TECHNICIENS -->
  <div class="modal-overlay" *ngIf="showTechniciensModal" (click)="closeModal()">
    <div class="modal-content techniciens-modal" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="closeModal()">Ã—</button>
      <h2>ğŸ‘· Liste des Techniciens</h2>
      <p class="subtitle">Total : {{ techniciens.length }} technicien(s) disponible(s)</p>

      <div class="techniciens-grid">
        <div class="technicien-card" *ngFor="let tech of techniciens">
          <div class="tech-header">
            <h4>{{ tech.nom }}</h4>
            <span class="status" 
                  [ngClass]="tech.disponibilite ? 'done' : 'error'"
                  [style.text-transform]="'uppercase'">
              {{ tech.disponibilite ? 'âœ… DISPONIBLE' : 'âŒ OCCUPÃ‰' }}
            </span>
          </div>
          <div class="equip-details">
            <p>ğŸ“§ <strong>Email :</strong> {{ tech.email }}</p>
            <p><strong>ğŸ¯ CompÃ©tences :</strong></p>
            <div class="competences-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
              <span class="priority basse" 
                    *ngFor="let c of tech.competences"
                    style="display: inline-block;">
                {{ c }}
              </span>
              <span class="text-muted" *ngIf="!tech.competences?.length">Aucune compÃ©tence</span>
            </div>
          </div>
        </div>
        <div class="no-data" *ngIf="!techniciens.length">
          <div style="font-size: 48px;">ğŸ‘·</div>
          <p>Aucun technicien trouvÃ©</p>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DÃ‰TAILS DEMANDE -->
  <div class="modal-overlay" *ngIf="showDetailModal && selectedDemande" (click)="closeDetailModal()">
    <div class="modal-content detail-modal" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="closeDetailModal()">Ã—</button>
      <div class="detail-header">
        <h2>ğŸ“‹ DÃ©tail de la demande #{{ selectedDemande.id }}</h2>
        <span class="status" [ngClass]="getEtatBadgeClass(selectedDemande.etat)">
          {{ getEtatText(selectedDemande.etat) }}
        </span>
      </div>
      <div class="detail-grid">
        <div class="detail-left">
          <div class="info-block">
            <h3>ğŸ“ Description complÃ¨te</h3>
            <p class="description">{{ selectedDemande.description }}</p>
          </div>
          <div class="info-block">
            <h3>ğŸ“… Date de soumission</h3>
            <p>{{ selectedDemande.dateSoumission | date:'fullDate' }}</p>
          </div>
          <div class="info-block">
            <h3>ğŸ“ Localisation GPS</h3>
            <ng-container *ngIf="selectedDemande.localisation as loc; else noLocation">
              <p><strong>Lat:</strong> {{ loc.latitude | number:'1.6' }}<br>
                 <strong>Lng:</strong> {{ loc.longitude | number:'1.6' }}</p>
              <a [href]="'https://www.google.com/maps?q=' + loc.latitude + ',' + loc.longitude" target="_blank" class="map-link">
                Voir sur Google Maps
              </a>
            </ng-container>
            <ng-template #noLocation><p class="text-muted">Localisation non fournie</p></ng-template>
          </div>
          <div class="action-buttons" *ngIf="selectedDemande.etat !== 'TRAITEE'">
            <button class="action-btn primary large" (click)="planifierDemande(selectedDemande)">
              Planifier l'intervention
            </button>
          </div>
        </div>
        <div class="detail-right">
          <h3>Photos jointes ({{ selectedDemande.photos?.length || 0 }})</h3>
          <div class="photos-grid" *ngIf="selectedDemande.photos?.length; else noPhotos">
            <div class="photo-item" *ngFor="let photo of selectedDemande.photos">
              <div class="photo-container">
                <img [src]="getPhotoUrl(photo.url)" [alt]="photo.nom" (error)="handleImageError($event)" class="demande-photo">
                <div class="photo-overlay">
                  <button class="view-photo-btn" (click)="openPhotoModal(getPhotoUrl(photo.url))">Agrandir</button>
                </div>
              </div>
              <p class="photo-caption">{{ photo.nom || 'Photo' }}</p>
            </div>
          </div>
          <ng-template #noPhotos>
            <div class="no-photos-message"><div class="no-photos-icon">Photo</div><p>Aucune photo</p></div>
          </ng-template>
        </div>
      </div>
      <div class="detail-actions">
        <button class="action-btn secondary" (click)="closeDetailModal()">Fermer</button>
      </div>
    </div>
  </div>

  <!-- MODAL INTERVENTIONS -->
  <div class="modal-overlay" *ngIf="showInterventionModal" (click)="closeModal()">
    <div class="modal-content interventions-modal" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="closeModal()">Ã—</button>
      <h2>Liste des Interventions</h2>
      <div class="interventions-list">
        <div class="intervention-card" *ngFor="let i of interventions">
          <div class="intervention-header">
            <h4>Intervention #{{ i.id }}</h4>
            <span [ngClass]="getEtatBadgeClass(i.etat)">{{ i.etat }}</span>
          </div>
          <div class="intervention-details">
            <p><strong>PrioritÃ©:</strong> {{ i.priorite }}</p>
            <p><strong>Date:</strong> {{ i.datePlanifiee | date:'dd/MM/yyyy' }}</p>
            <p><strong>Budget:</strong> {{ i.budget | currency:'EUR' }}</p>
            <p *ngIf="i.technicienId"><strong>Technicien:</strong> #{{ i.technicienId }}</p>
          </div>
        </div>
        <div *ngIf="!interventions.length" class="no-data">Aucune intervention planifiÃ©e</div>
      </div>
    </div>
  </div>

  <!-- MODAL Ã‰QUIPEMENTS -->
  <div class="modal-overlay" *ngIf="showEquipementModal" (click)="closeModal()">
    <div class="modal-content equipements-modal" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="closeModal()">Ã—</button>
      <h2>Gestion des Ã‰quipements</h2>
      <div class="modal-actions">
        <button class="action-btn success" (click)="openAddEquipement()">+ Nouvel Ã©quipement</button>
      </div>
      <div class="equipements-grid">
        <div class="equip-card" *ngFor="let e of equipements">
          <div class="equip-header">
            <h4>{{ e.type }}</h4>
            <span [ngClass]="getEtatBadgeClass(e.etat)">{{ getEtatText(e.etat) }}</span>
          </div>
          <div class="equip-details">
            <p><strong>Valeur:</strong> {{ e.valeurAchat | currency:'EUR' }}</p>
            <p *ngIf="e.fournisseur"><strong>Fournisseur:</strong> {{ e.fournisseur.nom }}</p>
            <p *ngIf="e.localisation">
              <strong>Localisation:</strong>
              {{ e.localisation.latitude | number:'1.4' }}, {{ e.localisation.longitude | number:'1.4' }}
            </p>
          </div>
          <div class="equip-actions">
            <button class="btn-small edit" (click)="editEquipement(e)">Modifier</button>
            <button class="btn-small delete" (click)="deleteEquipement(e.id)">Supprimer</button>
          </div>
        </div>
        <div *ngIf="!equipements.length" class="no-data Quasi">Aucun Ã©quipement enregistrÃ©</div>
      </div>
    </div>
  </div>

  <!-- MODAL MATÃ‰RIELS -->
  <div class="modal-overlay" *ngIf="showRessourceModal" (click)="closeModal()">
    <div class="modal-content ressources-modal" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="closeModal()">Ã—</button>
      <h2>Gestion des MatÃ©riels</h2>
      <div class="modal-actions">
        <button class="action-btn success" (click)="openAddRessource()">+ Nouvel matÃ©riel</button>
      </div>
      <div class="ressources-grid">
        <div class="ress-card" *ngFor="let r of ressources">
          <div class="ress-header"><h4>{{ r.designation }}</h4></div>
          <div class="ress-details">
            <p><strong>QuantitÃ©:</strong> {{ r.quantiteEnStock }}</p>
            <p><strong>Valeur:</strong> {{ r.valeurAchat | currency:'EUR' }}</p>
            <p *ngIf="r.fournisseur"><strong>Fournisseur:</strong> {{ r.fournisseur.nom }}</p>
          </div>
          <div class="ress-actions">
            <button class="btn-small edit" (click)="editRessource(r)">Modifier</button>
            <button class="btn-small delete" (click)="deleteRessource(r.id)">Supprimer</button>
          </div>
        </div>
        <div *ngIf="!ressources.length" class="no-data">Aucun matÃ©riel enregistrÃ©</div>
      </div>
    </div>
  </div>

  <!-- MODAL FORMULAIRE Ã‰QUIPEMENT -->
  <div class="modal-overlay" *ngIf="showFormModal" (click)="closeModal()">
    <div class="modal-content form-modal" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="closeModal()">Ã—</button>
      <h2>{{ editingEquipement ? 'Modifier' : 'Ajouter' }} un Ã©quipement</h2>
      <form (ngSubmit)="saveEquipement()" class="equipement-form">
        <div class="form-group">
          <label>Type d'Ã©quipement *</label>
          <input [(ngModel)]="currentEquipement.type" name="type" placeholder="Ex: Camion-benne..." required>
        </div>
        <div class="form-group">
          <label>Ã‰tat</label>
          <select [(ngModel)]="currentEquipement.etat" name="etat">
            <option value="FONCTIONNEL">Fonctionnel</option>
            <option value="DEFECTUEUX">DÃ©fectueux</option>
            <option value="EN_MAINTENANCE">En maintenance</option>
          </select>
        </div>
        <div class="form-group">
          <label>Valeur d'achat (â‚¬)</label>
          <input type="number" [(ngModel)]="currentEquipement.valeurAchat" name="valeurAchat" step="0.01" min="0">
        </div>
        <div class="form-actions">
          <button type="button" class="action-btn secondary" (click)="closeModal()">Annuler</button>
          <button type="submit" class="action-btn primary">Sauvegarder</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL CARTE DES DEMANDES -->
  <div class="modal-overlay" *ngIf="showMapModal" (click)="closeMapModal()">
    <div class="modal-content map-modal" (click)="$event.stopPropagation()" style="max-width: 1200px; width: 95%; height: 85vh;">
      <button class="close-btn" (click)="closeMapModal()">Ã—</button>
      <h2>ğŸ—ºï¸ Carte des demandes non traitÃ©es</h2>
      
      <!-- LÃ©gende -->
      <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 20px; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; border-radius: 50%; background: #f44336; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
          <span style="font-weight: 600; color: #333;">ğŸ”´ Urgent</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; border-radius: 50%; background: #FFC107; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
          <span style="font-weight: 600; color: #333;">ğŸŸ¡ Moyen</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; border-radius: 50%; background: #4CAF50; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
          <span style="font-weight: 600; color: #333;">ğŸŸ¢ Bas</span>
        </div>
        <div style="margin-left: 20px; color: #667eea; font-weight: 700;">
          Total: {{ demandesNonTraitees.length }} demande(s)
        </div>
      </div>

      <!-- Carte Leaflet -->
      <div id="mapChef" style="height: calc(100% - 120px); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
    </div>
  </div>

  <!-- MODAL CARTE DES INTERVENTIONS -->
  <div class="modal-overlay" *ngIf="showMapInterventionsModal" (click)="closeMapInterventionsModal()">
    <div class="modal-content map-modal" (click)="$event.stopPropagation()" style="max-width: 1200px; width: 95%; height: 85vh;">
      <button class="close-btn" (click)="closeMapInterventionsModal()">Ã—</button>
      <h2>ğŸ—ºï¸ Carte des interventions en cours</h2>
      
      <!-- LÃ©gende -->
      <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 20px; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; border-radius: 50%; background: #2196F3; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
          <span style="font-weight: 600; color: #333;">ğŸ”µ En cours</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; border-radius: 50%; background: #FF9800; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
          <span style="font-weight: 600; color: #333;">ğŸŸ  En attente</span>
        </div>
        <div style="margin-left: 20px; color: #667eea; font-weight: 700;">
          Total: {{ interventionsEnCours.length }} intervention(s)
        </div>
      </div>

      <!-- Carte Leaflet -->
      <div id="mapInterventions" style="height: calc(100% - 120px); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
    </div>
  </div>

</div>
