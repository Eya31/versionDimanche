<div class="planification-container">
  <!-- Ã‰tape 1: DÃ©finir les exigences -->
  <div *ngIf="etapeActuelle === 'exigences'" class="etape-exigences">
    <h2>ğŸ“‹ DÃ©finir les exigences de l'intervention</h2>
    
    <!-- CompÃ©tences requises -->
    <div class="section-exigences">
      <h3>ğŸ‘¨â€ğŸ”§ CompÃ©tences des techniciens requises</h3>
      
      <div class="ajout-exigence">
        <select 
          [(ngModel)]="nouvelleCompetence.competence" 
          class="form-control"
        >
          <option value="">-- SÃ©lectionner une compÃ©tence --</option>
          <option *ngFor="let comp of listeCompetencesDisponibles" [value]="comp">
            {{ comp }}
          </option>
        </select>
        <input 
          type="number" 
          [(ngModel)]="nouvelleCompetence.nombreTechniciens" 
          min="1"
          placeholder="Nombre"
          class="form-control nombre-input"
        />
        <button (click)="ajouterCompetence()" class="btn btn-primary">
          + Ajouter
        </button>
      </div>

      <div class="liste-exigences">
        <div *ngFor="let comp of competencesRequises; let i = index" class="exigence-item">
          <span>{{ comp.competence }} ({{ comp.nombreTechniciens }} technicien(s))</span>
          <button (click)="supprimerCompetence(i)" class="btn-supprimer">Ã—</button>
        </div>
        <div *ngIf="competencesRequises.length === 0" class="empty-state">
          Aucune compÃ©tence ajoutÃ©e
        </div>
      </div>
    </div>

    <!-- MatÃ©riels requis -->
    <div class="section-exigences">
      <h3>ğŸ”§ MatÃ©riels requis</h3>
      
      <div class="ajout-exigence">
        <select 
          [(ngModel)]="nouveauMateriel.designation" 
          class="form-control"
        >
          <option value="">-- SÃ©lectionner un matÃ©riel --</option>
          <option *ngFor="let mat of listeMaterielsDisponibles" [value]="mat.designation">
            {{ mat.designation }} (Stock: {{ mat.quantiteEnStock }})
          </option>
        </select>
        <input 
          type="number" 
          [(ngModel)]="nouveauMateriel.quantiteRequise" 
          min="1"
          placeholder="QuantitÃ©"
          class="form-control nombre-input"
        />
        <button (click)="ajouterMateriel()" class="btn btn-primary">
          + Ajouter
        </button>
      </div>

      <div class="liste-exigences">
        <div *ngFor="let mat of materielsRequis; let i = index" class="exigence-item">
          <span>{{ mat.designation }} ({{ mat.quantiteRequise }} unitÃ©(s))</span>
          <button (click)="supprimerMateriel(i)" class="btn-supprimer">Ã—</button>
        </div>
        <div *ngIf="materielsRequis.length === 0" class="empty-state">
          Aucun matÃ©riel ajoutÃ©
        </div>
      </div>
    </div>

    <!-- Ã‰quipements requis -->
    <div class="section-exigences">
      <h3>ğŸšœ Ã‰quipements requis</h3>
      
      <div class="ajout-exigence">
        <select 
          [(ngModel)]="nouvelEquipement.type" 
          class="form-control"
        >
          <option value="">-- SÃ©lectionner un type d'Ã©quipement --</option>
          <option *ngFor="let type of listeEquipementsDisponibles" [value]="type">
            {{ type }}
          </option>
        </select>
        <input 
          type="number" 
          [(ngModel)]="nouvelEquipement.quantiteRequise" 
          min="1"
          placeholder="QuantitÃ©"
          class="form-control nombre-input"
        />
        <button (click)="ajouterEquipement()" class="btn btn-primary">
          + Ajouter
        </button>
      </div>

      <div class="liste-exigences">
        <div *ngFor="let eq of equipementsRequis; let i = index" class="exigence-item">
          <span>{{ eq.type }} ({{ eq.quantiteRequise }} Ã©quipement(s))</span>
          <button (click)="supprimerEquipement(i)" class="btn-supprimer">Ã—</button>
        </div>
        <div *ngIf="equipementsRequis.length === 0" class="empty-state">
          Aucun Ã©quipement ajoutÃ©
        </div>
      </div>
    </div>

    <!-- PÃ©riode de recherche -->
    <div class="section-periode">
      <h3>ğŸ“… PÃ©riode de recherche</h3>
      <div class="periode-inputs">
        <div class="form-group">
          <label>Date de dÃ©but</label>
          <input type="date" [(ngModel)]="dateDebut" class="form-control" />
        </div>
        <div class="form-group">
          <label>Date de fin</label>
          <input type="date" [(ngModel)]="dateFin" class="form-control" />
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button (click)="annuler()" class="btn btn-secondary">Annuler</button>
      <button 
        (click)="validerDates()" 
        class="btn btn-primary"
        [disabled]="isLoading"
      >
        <span *ngIf="!isLoading">ğŸ” Rechercher les dates disponibles</span>
        <span *ngIf="isLoading">â³ Recherche en cours...</span>
      </button>
    </div>
  </div>

  <!-- Ã‰tape 2: Calendrier avec validation -->
  <div *ngIf="etapeActuelle === 'calendrier'" class="etape-calendrier">
    <h2>ğŸ“† SÃ©lectionner une date d'intervention</h2>

    <!-- Statistiques -->
    <div class="stats-dates">
      <div class="stat-item vert">
        <span class="stat-number">{{ nombreDatesVertes }}</span>
        <span class="stat-label">Dates disponibles</span>
      </div>
      <div class="stat-item jaune">
        <span class="stat-number">{{ nombreDatesJaunes }}</span>
        <span class="stat-label">Dates partielles</span>
      </div>
      <div class="stat-item rouge">
        <span class="stat-number">{{ nombreDatesRouges }}</span>
        <span class="stat-label">Dates indisponibles</span>
      </div>
    </div>

    <!-- LÃ©gende -->
    <div class="legende">
      <div class="legende-item">
        <span class="color-box vert"></span>
        <span>Toutes les ressources disponibles</span>
      </div>
      <div class="legende-item">
        <span class="color-box jaune"></span>
        <span>Techniciens et Ã©quipements OK, matÃ©riel insuffisant</span>
      </div>
      <div class="legende-item">
        <span class="color-box rouge"></span>
        <span>Ressources manquantes</span>
      </div>
    </div>

    <!-- Calendrier -->
    <div class="calendrier-container">
      <div *ngFor="let mois of calendrierMois" class="mois-calendrier">
        <h3 class="mois-titre">{{ mois.nom }}</h3>
        
        <div class="calendrier-table">
          <!-- En-tÃªte des jours de la semaine -->
          <div class="calendrier-header">
            <div *ngFor="let jour of joursSemaine" class="jour-header">
              {{ jour }}
            </div>
          </div>
          
          <!-- Semaines -->
          <div *ngFor="let semaine of mois.semaines" class="calendrier-semaine">
            <div 
              *ngFor="let jour of semaine" 
              class="calendrier-jour"
              [class.vide]="jour.vide"
              [class.disponible]="jour.status === 'VERT'"
              [class.partiel]="jour.status === 'JAUNE'"
              [class.indisponible]="jour.status === 'ROUGE'"
              [class.hors-periode]="!jour.status"
              (click)="!jour.vide && jour.status && selectionnerDate(jour.date, jour.status)"
            >
              <div class="jour-numero" *ngIf="!jour.vide">
                {{ jour.numero }}
              </div>
              <div class="jour-indicateur" *ngIf="!jour.vide && jour.status">
                <span class="cercle" [class.vert]="jour.status === 'VERT'" 
                                      [class.jaune]="jour.status === 'JAUNE'" 
                                      [class.rouge]="jour.status === 'ROUGE'"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button (click)="retourEtape()" class="btn btn-secondary">â† Retour</button>
    </div>
  </div>

  <!-- Ã‰tape 3: SÃ©lection des ressources -->
  <div *ngIf="etapeActuelle === 'selection'" class="etape-selection">
    <h2>ğŸ¯ SÃ©lectionner les ressources pour le {{ formatDate(dateSelectionnee!) }}</h2>

    <div class="selection-container">
      <!-- SÃ©lection des techniciens -->
      <div class="section-selection">
        <h3>ğŸ‘¨â€ğŸ”§ SÃ©lectionner les techniciens</h3>
        <p class="info-requise">{{ competencesRequises.length }} compÃ©tence(s) requise(s)</p>
        
        <div class="liste-ressources">
          <div 
            *ngFor="let tech of techniciensDisponibles" 
            class="ressource-item"
            [class.selected]="techniciensSelectionnes.includes(tech.id)"
            (click)="toggleTechnicien(tech.id)"
          >
            <div class="ressource-info">
              <div class="ressource-nom">{{ tech.nom }}</div>
              <div class="ressource-details">
                ğŸ“§ {{ tech.email }}
              </div>
              <div class="ressource-competences">
                <span *ngFor="let comp of tech.competences" class="badge-competence">
                  {{ comp }}
                </span>
              </div>
            </div>
            <div class="ressource-action">
              <span *ngIf="techniciensSelectionnes.includes(tech.id)" class="check-icon">âœ“</span>
            </div>
          </div>
          <div *ngIf="techniciensDisponibles.length === 0" class="empty-state">
            Aucun technicien disponible pour cette date
          </div>
        </div>
      </div>

      <!-- SÃ©lection des Ã©quipements -->
      <div class="section-selection">
        <h3>ğŸšœ SÃ©lectionner les Ã©quipements</h3>
        <p class="info-requise">{{ equipementsRequis.length }} type(s) d'Ã©quipement requis</p>
        
        <div class="liste-ressources">
          <div 
            *ngFor="let eq of equipementsDisponibles" 
            class="ressource-item"
            [class.selected]="equipementsSelectionnes.includes(eq.id)"
            (click)="toggleEquipement(eq.id)"
          >
            <div class="ressource-info">
              <div class="ressource-nom">{{ eq.nom }}</div>
              <div class="ressource-details">
                ğŸ·ï¸ Type: {{ eq.type }} | âš™ï¸ Ã‰tat: {{ eq.etat }}
              </div>
            </div>
            <div class="ressource-action">
              <span *ngIf="equipementsSelectionnes.includes(eq.id)" class="check-icon">âœ“</span>
            </div>
          </div>
          <div *ngIf="equipementsDisponibles.length === 0" class="empty-state">
            Aucun Ã©quipement disponible
          </div>
        </div>
      </div>

      <!-- SÃ©lection des matÃ©riels -->
      <div class="section-selection">
        <h3>ğŸ”§ DÃ©finir les quantitÃ©s de matÃ©riels</h3>
        <p class="info-requise">{{ materielsRequis.length }} matÃ©riel(aux) requis</p>
        
        <div class="liste-ressources">
          <div *ngFor="let mat of materielsDisponibles" class="ressource-item materiel">
            <div class="ressource-info">
              <div class="ressource-nom">{{ mat.designation }}</div>
              <div class="ressource-details">
                ğŸ“¦ Stock disponible: {{ mat.quantiteEnStock }} {{ mat.unite || 'unitÃ©(s)' }}
              </div>
              <div class="ressource-details">
                âœ… Requis: {{ getQuantiteRequise(mat.designation) }}
              </div>
            </div>
            <div class="ressource-action">
              <input 
                type="number" 
                [value]="getQuantiteSelectionnee(mat.id)"
                (input)="setQuantiteMateriel(mat.id, +$any($event.target).value)"
                [max]="mat.quantiteEnStock"
                [min]="0"
                class="quantite-input"
                placeholder="QuantitÃ©"
              />
            </div>
          </div>
          <div *ngIf="materielsDisponibles.length === 0" class="empty-state">
            Aucun matÃ©riel disponible en stock suffisant
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button (click)="retourEtape()" class="btn btn-secondary">â† Retour au calendrier</button>
      <button 
        (click)="validerSelections()" 
        class="btn btn-primary"
        [disabled]="!selectionsValides()"
      >
        Valider les sÃ©lections â†’
      </button>
    </div>
  </div>

  <!-- Ã‰tape 4: Confirmation -->
  <div *ngIf="etapeActuelle === 'confirmation'" class="etape-confirmation">
    <h2>âœ… Confirmer la planification</h2>

    <div class="confirmation-details">
      <div class="detail-section">
        <h3>ğŸ“… Date sÃ©lectionnÃ©e</h3>
        <p class="date-selected">{{ formatDate(dateSelectionnee!) }}</p>
      </div>

      <div class="detail-section">
        <h3>ğŸ“‹ RÃ©capitulatif des exigences</h3>
        
        <div class="recap-item" *ngIf="competencesRequises.length > 0">
          <strong>CompÃ©tences :</strong>
          <ul>
            <li *ngFor="let comp of competencesRequises">
              {{ comp.competence }} ({{ comp.nombreTechniciens }} technicien(s))
            </li>
          </ul>
        </div>

        <div class="recap-item" *ngIf="materielsRequis.length > 0">
          <strong>MatÃ©riels :</strong>
          <ul>
            <li *ngFor="let mat of materielsRequis">
              {{ mat.designation }} ({{ mat.quantiteRequise }} unitÃ©(s))
            </li>
          </ul>
        </div>

        <div class="recap-item" *ngIf="equipementsRequis.length > 0">
          <strong>Ã‰quipements :</strong>
          <ul>
            <li *ngFor="let eq of equipementsRequis">
              {{ eq.type }} ({{ eq.quantiteRequise }} Ã©quipement(s))
            </li>
          </ul>
        </div>
      </div>

      <div class="validation-status">
        <div class="status-badge success">
          âœ… Cette date remplit toutes les conditions
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button (click)="retourEtape()" class="btn btn-secondary">â† Retour</button>
      <button (click)="confirmerPlanification()" class="btn btn-success">
        âœ… Confirmer la planification
      </button>
    </div>
  </div>
</div>
