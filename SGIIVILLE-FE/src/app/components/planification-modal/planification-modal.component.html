<div class="modal-overlay planification-modal" (click)="close()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <!-- En-tÃªte -->
    <div class="modal-header">
      <h2>ğŸ“… Planifier l'intervention</h2>
      <button class="close-btn" (click)="close()">Ã—</button>
    </div>

    <!-- Informations de la demande -->
    <div class="demande-info">
      <h3>Demande #{{ demande.id }}</h3>
      <p class="description">{{ demande.description }}</p>
      <div class="metadata">
        <span class="priority" [class]="demande.priority?.toLowerCase()">
          ğŸ·ï¸ {{ demande.priority || 'MOYENNE' }}
        </span>
        <span class="category">ğŸ“‚ {{ demande.category || 'GÃ©nÃ©ral' }}</span>
      </div>
    </div>

    <!-- Ã‰tape 1: SÃ©lection des ressources -->
    <div *ngIf="etapeActuelle === 'selection'" class="etape-selection">
      <h3>1. SÃ©lection des ressources</h3>

      <!-- Date et filtres -->
      <div class="form-section">
        <div class="form-group">
          <label>ğŸ“… Date planifiÃ©e *</label>
<input type="date" [(ngModel)]="dateSelectionnee" [min]="getDateMin()">
        </div>

        <div class="form-group">
          <label>ğŸ¯ Filtre compÃ©tences</label>
          <input type="text" [(ngModel)]="competencesFiltre"
                 placeholder="Ex: Ã‰lectricitÃ©, Plomberie...">
        </div>
      </div>

      <!-- SÃ©lection des techniciens -->
      <div class="resource-section">
        <h4>ğŸ‘· Techniciens ({{ planification.techniciensIds.length }} sÃ©lectionnÃ©s)</h4>
        <div class="techniciens-grid">
          <div *ngFor="let tech of techniciens"
               class="technicien-card"
               [class.selected]="planification.techniciensIds.includes(tech.id)"
               [class.disabled]="!isTechnicienDisponible(tech.id) && dateSelectionnee"
               (click)="toggleTechnicien(tech.id)">

            <div class="tech-header">
              <h5>{{ tech.nom }}</h5>
              <span class="dispo-indicator"
                    [class.disponible]="isTechnicienDisponible(tech.id)"
                    [class.indisponible]="!isTechnicienDisponible(tech.id) && dateSelectionnee">
                {{ dateSelectionnee ?
                   (isTechnicienDisponible(tech.id) ? 'âœ…' : 'âŒ') :
                   'â³' }}
              </span>
            </div>

            <div class="tech-details">
              <p>ğŸ“§ {{ tech.email }}</p>
              <p>ğŸ¯ {{ tech.competences?.join(', ') || 'CompÃ©tences non dÃ©finies' }}</p>
              <small *ngIf="dateSelectionnee && !isTechnicienDisponible(tech.id)" class="indispo-text">
                Indisponible le {{ dateSelectionnee }}
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- SÃ©lection des Ã©quipements -->
      <div class="resource-section">
        <h4>ğŸ› ï¸ Ã‰quipements</h4>
        <div class="checkbox-grid">
          <label *ngFor="let eq of equipements" class="checkbox-item">
            <input type="checkbox"
                   [value]="eq.id"
                   [checked]="planification.equipementsIds.includes(eq.id)"
                   (change)="toggleEquipementSelection(eq.id)">

            <span class="checkmark"></span>
            {{ eq.type }}
            <small>({{ eq.etat }})</small>
          </label>
        </div>
      </div>

      <!-- SÃ©lection des ressources matÃ©rielles -->
      <div class="resource-section">
        <h4>ğŸ“¦ Ressources matÃ©rielles</h4>
        <div class="checkbox-grid">
          <label *ngFor="let res of ressources" class="checkbox-item">
            <input type="checkbox"
                   [value]="res.id"
                   [checked]="planification.ressourcesIds.includes(res.id)"
                   (change)="toggleRessourceSelection(res.id)">
            <span class="checkmark"></span>
            {{ res.designation }}
            <small>(Stock: {{ res.quantiteEnStock }})</small>
          </label>
        </div>
      </div>

      <!-- ParamÃ¨tres avancÃ©s -->
      <div class="form-section">
        <div class="form-group">
          <label>ğŸ¯ PrioritÃ©</label>
          <select [(ngModel)]="planification.priorite">
            <option value="HAUTE">ğŸ”´ Haute</option>
            <option value="MOYENNE">ğŸŸ¡ Moyenne</option>
            <option value="BASSE">ğŸŸ¢ Basse</option>
          </select>
        </div>

        <div class="form-group">
          <label>ğŸ’° Budget estimÃ© (DT)</label>
          <input type="number" [(ngModel)]="planification.budget" min="0" step="50">
        </div>
      </div>

      <!-- Actions -->
      <div class="modal-actions">
        <button class="btn secondary" (click)="close()">Annuler</button>
        <button class="btn primary"
                (click)="verifierDisponibilites()"
                [disabled]="!peutPasserVerification() || verificationEnCours">
          {{ verificationEnCours ? 'VÃ©rification...' : 'VÃ©rifier disponibilitÃ©s â†’' }}
        </button>
      </div>
    </div>

    <!-- Ã‰tape 2: VÃ©rification des disponibilitÃ©s -->
    <div *ngIf="etapeActuelle === 'verification'" class="etape-verification">
      <h3>2. VÃ©rification des disponibilitÃ©s</h3>

      <!-- RÃ©sumÃ© techniciens -->
      <div class="verification-section" [class.success]="nombreTechniciensDisponibles > 0">
        <h4>ğŸ‘· Techniciens disponibles</h4>
        <div class="verification-result">
          <span class="status-icon">
            {{ nombreTechniciensDisponibles > 0 ? 'âœ…' : 'âŒ' }}
          </span>
          <span class="status-text">
            {{ nombreTechniciensDisponibles }} / {{ techniciens.length }} techniciens disponibles
          </span>
        </div>

        <div class="disponibilites-list">
          <div *ngFor="let tech of techniciensDisponibles" class="dispo-item">
            <span class="tech-name">{{ getTechName(tech.technicienId) }}</span>
            <span class="creneaux" [class.disponible]="tech.disponible">
              {{ getCreneauxTechnicien(tech.technicienId) }}
            </span>
          </div>
        </div>
      </div>

      <!-- RÃ©sumÃ© ressources -->
      <div class="verification-section" [class.success]="tousRessourcesDisponibles">
        <h4>ğŸ“¦ Ressources disponibles</h4>
        <div class="verification-result">
          <span class="status-icon">
            {{ tousRessourcesDisponibles ? 'âœ…' : 'âŒ' }}
          </span>
          <span class="status-text">
            {{ tousRessourcesDisponibles ? 'Toutes disponibles' : 'Ressources manquantes' }}
          </span>
        </div>

        <div *ngIf="ressourcesDisponibilite?.message" class="ressource-message">
          {{ ressourcesDisponibilite?.message }}
        </div>
      </div>

      <!-- Actions -->
      <div class="modal-actions">
        <button class="btn secondary" (click)="retourEtapePrecedente()">â† Retour</button>
        <button class="btn primary"
                (click)="confirmerPlanification()"
                [disabled]="!tousRessourcesDisponibles || nombreTechniciensDisponibles === 0">
          Confirmer la planification â†’
        </button>
      </div>
    </div>

    <!-- Ã‰tape 3: Confirmation -->
    <div *ngIf="etapeActuelle === 'confirmation'" class="etape-confirmation">
      <h3>3. Confirmation</h3>

      <div class="confirmation-summary">
        <div class="summary-card">
          <h4>ğŸ“‹ RÃ©capitulatif de l'intervention</h4>
          <div class="summary-details">
            <p><strong>Date:</strong> {{ planification.datePlanifiee | date:'fullDate' }}</p>
            <p><strong>Techniciens:</strong> {{ planification.techniciensIds.length }}</p>
            <p><strong>PrioritÃ©:</strong> {{ planification.priorite }}</p>
            <p><strong>Budget:</strong> {{ planification.budget }} DT</p>
          </div>
        </div>

        <div class="confirmation-actions">
          <button class="btn secondary" (click)="retourEtapePrecedente()">â† Modifier</button>
          <button class="btn success" (click)="finaliserPlanification()">
            âœ… Planifier l'intervention
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
