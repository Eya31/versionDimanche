<div class="intervention-detail" *ngIf="intervention">
  <header class="overview-header">
    <div class="header-content">
      <h1>üß≠ Intervention #{{intervention.id}}</h1>
      <div class="intervention-badges">
        <span class="badge" [ngClass]="getBadgeClass(intervention.etat)">
          {{getEtatLabel(intervention.etat)}}
        </span>
        <span class="badge badge-info" [style.color]="getPrioriteColor(intervention.priorite)" [style.border-color]="getPrioriteColor(intervention.priorite)">
          {{getPrioriteLabel(intervention.priorite)}}
        </span>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" (click)="retour()">
        <span class="icon">‚Üê</span>
        Retour
      </button>
    </div>
  </header>

  <!-- VUE SIMPLIFI√âE POUR MAIN-D'≈íUVRE -->
  <div class="detail-content" *ngIf="isMainDOeuvre">
    <!-- Informations principales -->
    <section class="card">
      <div class="card-header">
        <h2>üìã Informations de l'Intervention</h2>
      </div>
      <div class="card-body">
        <div class="info-grid">
          <div class="info-item">
            <strong>Description:</strong>
            <p>{{intervention.description || 'Non sp√©cifi√©e'}}</p>
          </div>
          <div class="info-item">
            <strong>Type:</strong>
            <span>{{intervention.typeIntervention || 'Non sp√©cifi√©'}}</span>
          </div>
          <div class="info-item">
            <strong>Priorit√©:</strong>
            <span class="badge badge-info" [style.color]="getPrioriteColor(intervention.priorite)" [style.border-color]="getPrioriteColor(intervention.priorite)">
              {{getPrioriteLabel(intervention.priorite)}}
            </span>
          </div>
          <div class="info-item">
            <strong>√âtat:</strong>
            <span class="badge" [ngClass]="getBadgeClass(intervention.etat)">
              {{getEtatLabel(intervention.etat)}}
            </span>
          </div>
          <div class="info-item" *ngIf="intervention.datePlanifiee">
            <strong>Date pr√©vue:</strong>
            <span>{{intervention.datePlanifiee | date:'dd/MM/yyyy'}}</span>
          </div>
          <div class="info-item" *ngIf="intervention.dateDebut">
            <strong>Date d√©but:</strong>
            <span>{{intervention.dateDebut | date:'dd/MM/yyyy HH:mm'}}</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Mes T√¢ches (uniquement celles assign√©es √† cette main-d'≈ìuvre) -->
    <section class="card">
      <div class="card-header">
        <h2>üìã Mes T√¢ches</h2>
      </div>
      <div class="card-body">
        <p class="section-subtitle">T√¢ches qui vous sont assign√©es pour cette intervention</p>

      <!-- Liste des t√¢ches -->
      <div class="taches-list">
        <div *ngIf="taches.length === 0" class="empty-taches">
          <p>üì≠ Aucune t√¢che assign√©e pour le moment</p>
          <p class="hint">Le technicien vous assignera des t√¢ches prochainement.</p>
        </div>

        <div *ngFor="let tache of taches" class="tache-card" [class]="getEtatTacheClass(tache.etat)">
          <div class="tache-header">
            <div class="tache-title">
              <span class="tache-ordre">#{{tache.ordre || tache.id}}</span>
              <h3>{{tache.libelle}}</h3>
            </div>
            <span class="badge-etat" [class]="getEtatTacheClass(tache.etat)">
              {{getEtatTacheLabel(tache.etat)}}
            </span>
          </div>

          <div class="tache-body" *ngIf="tache.description">
            <p>{{tache.description}}</p>
          </div>

          <div class="tache-info">
            <div class="info-item" *ngIf="tache.dateDebut">
              <strong>D√©but√©e le:</strong>
              <span>{{tache.dateDebut | date:'dd/MM/yyyy HH:mm'}}</span>
            </div>
            <div class="info-item" *ngIf="tache.dateFin">
              <strong>Termin√©e le:</strong>
              <span>{{tache.dateFin | date:'dd/MM/yyyy HH:mm'}}</span>
            </div>
            <div class="info-item" *ngIf="tache.tempsPasseMinutes">
              <strong>Temps pass√©:</strong>
              <span>{{tache.tempsPasseMinutes}} minutes</span>
            </div>
            <div class="info-item" *ngIf="tache.commentaireMainDOeuvre">
              <strong>Votre commentaire:</strong>
              <p>{{tache.commentaireMainDOeuvre}}</p>
            </div>
            <div class="info-item" *ngIf="tache.commentaireTechnicien">
              <strong>Commentaire du technicien:</strong>
              <p>{{tache.commentaireTechnicien}}</p>
            </div>
          </div>

          <div class="tache-actions">
            <!-- Commencer la t√¢che -->
            <button 
              *ngIf="tache.etat === 'A_FAIRE'" 
              class="btn-primary"
              (click)="commencerTacheMainDOeuvre(tache)">
              ‚ñ∂Ô∏è Commencer la t√¢che
            </button>

            <!-- Terminer la t√¢che -->
            <button 
              *ngIf="tache.etat === 'EN_COURS'" 
              class="btn-success"
              (click)="ouvrirTerminerTacheMainDOeuvre(tache)">
              ‚úÖ Terminer la t√¢che
            </button>

            <!-- T√¢che termin√©e, en attente de v√©rification -->
            <div *ngIf="tache.etat === 'TERMINEE' && !tache.verifiee" class="tache-en-attente">
              <p class="info-text">‚è≥ T√¢che termin√©e, en attente de v√©rification par le technicien</p>
            </div>

            <!-- T√¢che v√©rifi√©e -->
            <div *ngIf="tache.verifiee" class="tache-verifiee">
              <p class="success-text">‚úÖ T√¢che v√©rifi√©e et valid√©e par le technicien</p>
            </div>
          </div>
        </div>
      </div>
      </div>

      <!-- Modal pour terminer la t√¢che -->
      <div *ngIf="selectedTacheForTerminer" class="modal-terminer-tache">
        <div class="modal-content">
          <h3>Terminer la t√¢che: {{selectedTacheForTerminer.libelle}}</h3>
          <div class="form-group">
            <label>Commentaire (optionnel)</label>
            <textarea 
              [(ngModel)]="terminerTacheRequest.commentaire" 
              placeholder="Ajoutez un commentaire sur votre travail..."></textarea>
          </div>
          <div class="form-group">
            <label>Temps pass√© (minutes, optionnel)</label>
            <input 
              type="number" 
              [(ngModel)]="terminerTacheRequest.tempsPasseMinutes" 
              placeholder="Ex: 120">
          </div>
          <div class="modal-actions">
            <button class="btn-secondary" (click)="selectedTacheForTerminer = null">Annuler</button>
            <button class="btn-success" (click)="terminerTacheMainDOeuvre()">‚úÖ Terminer</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- VUE COMPL√àTE POUR TECHNICIEN -->
  <div class="detail-content" *ngIf="isTechnicien">
    <!-- Informations principales -->
    <section class="card">
      <div class="card-header">
        <h2>üìã Informations</h2>
      </div>
      <div class="card-body">
        <div class="info-grid">
        <div class="info-item">
          <strong>Description:</strong>
          <p>{{intervention.description || 'Non sp√©cifi√©e'}}</p>
        </div>
        <div class="info-item">
          <strong>Type:</strong>
          <span>{{intervention.typeIntervention || 'Non sp√©cifi√©'}}</span>
        </div>
        <div class="info-item">
          <strong>Priorit√©:</strong>
          <span class="badge" [class]="'priorite-' + (intervention.priorite || 'NORMALE').toLowerCase()">
            {{intervention.priorite}}
          </span>
        </div>
        <div class="info-item">
          <strong>√âtat:</strong>
          <span class="badge" [class]="'etat-' + (intervention.etat || 'EN_ATTENTE').toLowerCase()">
            {{intervention.etat}}
          </span>
        </div>
        <div class="info-item">
          <strong>Date pr√©vue:</strong>
          <span>{{intervention.datePlanifiee | date:'dd/MM/yyyy'}}</span>
        </div>
        <div class="info-item" *ngIf="intervention.dateDebut">
          <strong>Date d√©but:</strong>
          <span>{{intervention.dateDebut | date:'dd/MM/yyyy HH:mm'}}</span>
        </div>
        <div class="info-item" *ngIf="intervention.tempsPasseMinutes">
          <strong>Temps pass√©:</strong>
          <span>{{intervention.tempsPasseMinutes}} minutes</span>
        </div>
        <div class="info-item">
          <strong>Budget:</strong>
          <span>{{intervention.budget}} DT</span>
        </div>
      </div>
      </div>
    </section>

    <!-- Actions d'intervention (uniquement pour technicien) -->
    <section class="card" *ngIf="isTechnicien">
      <div class="card-header">
        <h2>‚ö° Actions</h2>
      </div>
      <div class="card-body">
      <div class="action-buttons">
        <button *ngIf="intervention.etat === 'EN_ATTENTE'" 
                class="btn-primary" 
                (click)="commencer()">
          Commencer l'intervention
        </button>
        <button *ngIf="intervention.etat === 'EN_COURS'" 
                class="btn-warning" 
                (click)="mettreEnPause()">
          Mettre en pause
        </button>
        <button *ngIf="intervention.etat === 'SUSPENDUE'" 
                class="btn-primary" 
                (click)="reprendre()">
          Reprendre
        </button>
        <button *ngIf="intervention.etat === 'EN_COURS'" 
                class="btn-success" 
                (click)="terminer()">
          Terminer
        </button>
        <button class="btn-secondary" 
                (click)="showUpdateEtat = !showUpdateEtat">
          Mettre √† jour l'√©tat
        </button>
      </div>

      <!-- Formulaire mise √† jour √©tat -->
      <div *ngIf="showUpdateEtat" class="update-etat-form">
        <h3>Mettre √† jour l'√©tat</h3>
        <select [(ngModel)]="updateEtatRequest.nouvelEtat">
          <option value="EN_ATTENTE">EN_ATTENTE</option>
          <option value="EN_COURS">EN_COURS</option>
          <option value="SUSPENDUE">SUSPENDUE</option>
          <option value="TERMINEE">TERMINEE</option>
        </select>
        <input type="number" 
               [(ngModel)]="updateEtatRequest.tempsPasseMinutes" 
               placeholder="Temps pass√© (minutes)">
        <textarea [(ngModel)]="updateEtatRequest.commentaire" 
                  placeholder="Commentaire"></textarea>
        <button class="btn-primary" (click)="updateEtat()">Enregistrer</button>
      </div>
      </div>
    </section>

    <!-- üìã GESTION DES T√ÇCHES -->
    <section class="card">
      <div class="card-header">
        <h2>üìã Gestion des T√¢ches</h2>
        <button *ngIf="isTechnicien" class="btn-primary" (click)="toggleCreateTacheForm()">
          {{showCreateTache ? '‚úï Annuler' : '‚ûï Cr√©er une t√¢che'}}
        </button>
      </div>
      <div class="card-body">

      <!-- Formulaire de cr√©ation de t√¢che (uniquement pour technicien) -->
      <div *ngIf="showCreateTache && isTechnicien" class="create-tache-form">
        <h3>Nouvelle t√¢che</h3>
        <div class="form-group">
          <label>Libell√© *</label>
          <input type="text" [(ngModel)]="nouvelleTache.libelle" placeholder="Ex: R√©paration du syst√®me √©lectrique">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="nouvelleTache.description" placeholder="Description d√©taill√©e de la t√¢che..."></textarea>
        </div>
        
        <!-- Filtres pour rechercher la main-d'≈ìuvre -->
        <div class="filters-main-doeuvre-inline">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4>Rechercher une main-d'≈ìuvre disponible</h4>
            <button type="button" class="btn-secondary btn-small" (click)="reinitialiserFiltresMainDOeuvre()" style="font-size: 0.85em;">
              üîÑ R√©initialiser les filtres
            </button>
          </div>
          <div class="filters-row">
            <input 
              type="text" 
              [(ngModel)]="rechercheMainDOeuvre"
              (input)="filtrerMainDOeuvreDisponible()"
              placeholder="Rechercher par nom, matricule, comp√©tence..."
              class="search-input-inline">
            
            <select 
              [(ngModel)]="filtreCompetenceMainDOeuvre"
              (change)="filtrerMainDOeuvreDisponible()"
              class="filter-select-inline">
              <option value="">Toutes les comp√©tences</option>
              <option *ngFor="let comp of competencesDisponibles" [value]="comp">{{comp}}</option>
            </select>
            
            <select 
              [(ngModel)]="filtreHabilitationMainDOeuvre"
              (change)="filtrerMainDOeuvreDisponible()"
              class="filter-select-inline">
              <option value="">Toutes les habilitations</option>
              <option *ngFor="let hab of habilitationsDisponibles" [value]="hab">{{hab}}</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Assigner √† une main-d'≈ìuvre disponible *</label>
          <select [(ngModel)]="nouvelleTache.mainDOeuvreId" required>
            <option [value]="undefined">S√©lectionner une main-d'≈ìuvre...</option>
            <option *ngFor="let md of mainDOeuvreListeFiltree" [value]="md.id">
              {{md.nom}} {{md.prenom || ''}}
              <span *ngIf="md.competence">
                - {{md.competence}}
              </span>
            </option>
          </select>
          <p class="hint-text" *ngIf="mainDOeuvreListeFiltree.length === 0">
            ‚ö†Ô∏è Aucune main-d'≈ìuvre disponible correspondant aux crit√®res. Utilisez les filtres ci-dessus ou <a routerLink="/technicien/main-doeuvre">cr√©ez une nouvelle fiche</a>.
          </p>
          <p class="info-text" *ngIf="mainDOeuvreListeFiltree.length > 0">
            ‚úÖ {{mainDOeuvreListeFiltree.length}} main-d'≈ìuvre disponible(s) correspondant aux crit√®res
          </p>
        </div>
        <button class="btn-success" (click)="creerTache()" [disabled]="!nouvelleTache.mainDOeuvreId || !nouvelleTache.libelle">
          üíæ Cr√©er la t√¢che et affecter la main-d'≈ìuvre
        </button>
      </div>

      <!-- Liste des t√¢ches -->
      <div class="taches-list">
        <div *ngIf="taches.length === 0" class="empty-taches">
          <p>üì≠ Aucune t√¢che cr√©√©e pour cette intervention</p>
          <p class="hint">Cr√©ez des t√¢ches et assignez-les directement √† une main-d'≈ìuvre disponible. La main-d'≈ìuvre sera automatiquement affect√©e lors de la cr√©ation de la t√¢che.</p>
        </div>

        <div *ngFor="let tache of taches" class="tache-card" [class]="getEtatTacheClass(tache.etat)">
          <div class="tache-header">
            <div class="tache-title">
              <span class="tache-ordre">#{{tache.ordre || tache.id}}</span>
              <h3>{{tache.libelle}}</h3>
            </div>
            <span class="badge-etat" [class]="getEtatTacheClass(tache.etat)">
              {{getEtatTacheLabel(tache.etat)}}
            </span>
          </div>

          <div class="tache-body" *ngIf="tache.description">
            <p>{{tache.description}}</p>
          </div>

          <div class="tache-info">
            <div class="info-item">
              <strong>Assign√©e √†:</strong>
              <span>{{getMainDOeuvreName(tache.mainDOeuvreId)}}</span>
            </div>
            <div class="info-item" *ngIf="tache.dateDebut">
              <strong>D√©but√©e le:</strong>
              <span>{{tache.dateDebut | date:'dd/MM/yyyy HH:mm'}}</span>
            </div>
            <div class="info-item" *ngIf="tache.dateFin">
              <strong>Termin√©e le:</strong>
              <span>{{tache.dateFin | date:'dd/MM/yyyy HH:mm'}}</span>
            </div>
            <div class="info-item" *ngIf="tache.tempsPasseMinutes">
              <strong>Temps pass√©:</strong>
              <span>{{tache.tempsPasseMinutes}} minutes</span>
            </div>
            <div class="info-item" *ngIf="tache.commentaireMainDOeuvre">
              <strong>Commentaire main-d'≈ìuvre:</strong>
              <p>{{tache.commentaireMainDOeuvre}}</p>
            </div>
            <div class="info-item" *ngIf="tache.commentaireTechnicien">
              <strong>Commentaire technicien:</strong>
              <p>{{tache.commentaireTechnicien}}</p>
            </div>
          </div>

          <div class="tache-actions">
            <!-- R√©assigner si non assign√©e (uniquement pour technicien) -->
            <div *ngIf="!tache.mainDOeuvreId && isTechnicien" class="assign-action">
              <label>Assigner √† une main-d'≈ìuvre disponible:</label>
              <select 
                [value]="getSelectedMainDOeuvre(tache.id) || ''"
                (change)="setSelectedMainDOeuvre(tache.id, +$any($event.target).value || undefined)">
                <option value="">S√©lectionner...</option>
                <option *ngFor="let md of mainDOeuvreListeFiltree" [value]="md.id">
                  {{md.nom}} {{md.prenom || ''}}<span *ngIf="md.competence"> - {{md.competence}}</span>
                </option>
              </select>
              <p *ngIf="mainDOeuvreListeFiltree.length === 0" class="warning-text">
                ‚ö†Ô∏è Aucune main-d'≈ìuvre disponible. Veuillez v√©rifier les filtres.
              </p>
              <button 
                *ngIf="mainDOeuvreListeFiltree.length > 0"
                class="btn-primary btn-small" 
                (click)="assignerTache(tache)"
                [disabled]="!getSelectedMainDOeuvre(tache.id)">
                Assigner
              </button>
            </div>

            <!-- V√©rifier si termin√©e (uniquement pour technicien) -->
            <button 
              *ngIf="tache.etat === 'TERMINEE' && !tache.verifiee && isTechnicien" 
              class="btn-success"
              (click)="ouvrirVerification(tache)">
              ‚úì V√©rifier
            </button>

            <!-- R√©assigner si √† refaire (uniquement pour technicien) -->
            <div *ngIf="tache.etat === 'A_FAIRE' && tache.verifiee === false && tache.mainDOeuvreId && isTechnicien" class="reassign-action">
              <p class="warning-text">‚ö†Ô∏è T√¢che √† refaire</p>
              <button class="btn-secondary btn-small" (click)="assignerTache(tache, tache.mainDOeuvreId!)">
                R√©assigner
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de v√©rification -->
      <div *ngIf="selectedTacheForVerify" class="modal-verification">
        <div class="modal-content">
          <h3>V√©rifier la t√¢che: {{selectedTacheForVerify.libelle}}</h3>
          <div class="form-group">
            <label>
              <input type="radio" [(ngModel)]="verificationValidee" [value]="true">
              ‚úÖ Valider la t√¢che
            </label>
            <label>
              <input type="radio" [(ngModel)]="verificationValidee" [value]="false">
              ‚ùå Demander √† refaire
            </label>
          </div>
          <div class="form-group">
            <label>Commentaire</label>
            <textarea [(ngModel)]="verificationComment" placeholder="Commentaire de v√©rification..."></textarea>
          </div>
          <div class="modal-actions">
            <button class="btn-secondary" (click)="selectedTacheForVerify = null">Annuler</button>
            <button class="btn-success" (click)="verifierTache()">Valider</button>
          </div>
        </div>
      </div>

      <!-- Bouton terminer intervention (uniquement pour technicien) -->
      <div class="terminer-intervention-section" *ngIf="isTechnicien">
        <!-- √âtat des t√¢ches - Indicateurs visuels -->
        <div class="taches-status-summary">
          <h3>üìã √âtat des T√¢ches</h3>
          
          <!-- Compteur de t√¢ches -->
          <div class="taches-counter">
            <div class="counter-item" [class.ok]="taches.length > 0">
              <span class="counter-number">{{taches.length}}</span>
              <span class="counter-label">T√¢ches totales</span>
            </div>
            
            <div class="counter-item" [class.ok]="tachesTerminees === taches.length && taches.length > 0">
              <span class="counter-number">{{tachesTerminees}}</span>
              <span class="counter-label">T√¢ches termin√©es</span>
            </div>
            
            <div class="counter-item" [class.ok]="tachesVerifiees === taches.length && taches.length > 0">
              <span class="counter-number">{{tachesVerifiees}}</span>
              <span class="counter-label">T√¢ches v√©rifi√©es</span>
            </div>
          </div>

          <!-- D√©tail des t√¢ches non termin√©es -->
          <div *ngIf="tachesNonTerminees.length > 0" class="alert alert-warning">
            <strong>‚ùå T√¢ches non termin√©es:</strong>
            <ul>
              <li *ngFor="let tache of tachesNonTerminees">
                "{{tache.libelle}}" - {{getEtatTacheLabel(tache.etat)}}
              </li>
            </ul>
          </div>

          <!-- D√©tail des t√¢ches non v√©rifi√©es -->
          <div *ngIf="tachesNonVerifiees.length > 0" class="alert alert-warning">
            <strong>‚ö†Ô∏è T√¢ches non v√©rifi√©es:</strong>
            <ul>
              <li *ngFor="let tache of tachesNonVerifiees">
                "{{tache.libelle}}"
              </li>
            </ul>
          </div>

          <!-- Message de succ√®s -->
          <div *ngIf="peutTerminerIntervention()" class="alert alert-success">
            <strong>‚úÖ Parfait!</strong> Toutes les t√¢ches sont termin√©es et v√©rifi√©es. 
            Vous pouvez maintenant terminer l'intervention et acc√©der au rapport final.
          </div>
        </div>

        <!-- Bouton terminer intervention -->
        <button 
          class="btn-success btn-large" 
          (click)="terminerIntervention()"
          [disabled]="!peutTerminerIntervention()"
          [title]="peutTerminerIntervention() ? 'Cliquez pour terminer l\'intervention et acc√©der au rapport final' : 'Toutes les t√¢ches doivent √™tre termin√©es et v√©rifi√©es'">
          ‚úÖ Terminer l'intervention et acc√©der au rapport
        </button>
      </div>
      </div>
    </section>

    <!-- Photos et commentaires (uniquement pour technicien) -->
    <section class="card" *ngIf="isTechnicien">
      <div class="card-header">
        <h2>üì∏ Photos</h2>
      </div>
      <div class="card-body">
      <input type="file" 
             multiple 
             accept="image/*" 
             (change)="onFileSelected($event)">
      <button class="btn-primary" (click)="ajouterPhotos()">Ajouter photos</button>
      </div>
    </section>

    <section class="card" *ngIf="isTechnicien">
      <div class="card-header">
        <h2>üí¨ Commentaires</h2>
      </div>
      <div class="card-body">
      <div *ngIf="intervention.commentaire" class="commentaire-existant">
        <p>{{intervention.commentaire}}</p>
      </div>
      <textarea [(ngModel)]="nouveauCommentaire" 
                placeholder="Ajouter un commentaire..."></textarea>
      <button class="btn-primary" (click)="ajouterCommentaire()">Ajouter</button>
      </div>
    </section>
  </div>
</div>

