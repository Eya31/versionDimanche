<!-- ============================================
     GESTION MAIN D'Å’UVRE - INTERFACE HARMONISÃ‰E
     ============================================ -->

<div class="main-doeuvre-gestion">
  <!-- HEADER -->
  <header class="overview-header">
    <div class="header-content">
      <h1>ğŸ› ï¸ Gestion des Fiches de Main d'Å’uvre</h1>
      <p class="subtitle">
        CrÃ©ez et gÃ©rez les fiches de main d'Å“uvre avec comptes utilisateurs. Les agents peuvent se connecter pour consulter leurs interventions.
      </p>
    </div>
    <div class="header-actions">
      <button class="btn-primary" (click)="creerNouveau()" [attr.aria-label]="'CrÃ©er une nouvelle fiche'">
        â• Nouvelle Fiche
      </button>
      <button class="btn-secondary" (click)="retour()" [attr.aria-label]="'Retour au dashboard'">
        <span class="icon">â†</span>
        Retour
      </button>
    </div>
  </header>

  <!-- Filtres et Recherche -->
  <div class="card">
    <div class="card-header">
      <h2>ğŸ” Recherche et Filtres</h2>
    </div>
    <div class="card-body">
    
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="recherche" 
        (input)="appliquerFiltres()"
        placeholder="Rechercher par nom, prÃ©nom, matricule, compÃ©tence..."
        [attr.aria-label]="'Rechercher une fiche'">
    </div>
    
    <div class="filters">
      <select 
        [(ngModel)]="filtreCompetence" 
        (change)="loadMainDOeuvre()"
        [attr.aria-label]="'Filtrer par compÃ©tence'">
        <option value="">Toutes les compÃ©tences</option>
        <option *ngFor="let comp of competencesDisponibles" [value]="comp">{{comp}}</option>
      </select>
      
      <select 
        [(ngModel)]="filtreDisponibilite" 
        (change)="loadMainDOeuvre()"
        [attr.aria-label]="'Filtrer par disponibilitÃ©'">
        <option value="">Toutes les disponibilitÃ©s</option>
        <option value="LIBRE">âœ… Libre</option>
        <option value="OCCUPE">ğŸ”„ OccupÃ©</option>
        <option value="ARCHIVE">ğŸ—„ï¸ ArchivÃ©</option>
      </select>
    </div>
    </div>
  </div>

  <!-- Formulaire crÃ©ation/Ã©dition -->
  <div *ngIf="isCreating || isEditing" class="card form-card">
    <div class="form-card-header">
      <div class="form-header-content">
        <div class="form-icon">{{isCreating ? 'â•' : 'âœï¸'}}</div>
        <div>
          <h2>{{isCreating ? 'Nouvelle Fiche de Main d\'Å’uvre' : 'Modifier Fiche'}}</h2>
          <p class="form-description" *ngIf="isCreating">
            CrÃ©ez une fiche de main d'Å“uvre avec un compte utilisateur. L'agent pourra se connecter 
            pour consulter ses interventions. <strong>L'email est obligatoire</strong> pour crÃ©er le compte.
          </p>
          <p class="form-description" *ngIf="isEditing">
            Modifiez les informations de la fiche de main d'Å“uvre.
          </p>
        </div>
      </div>
      <button type="button" class="btn-close-form" (click)="annuler()" [attr.aria-label]="'Fermer le formulaire'">
        âœ•
      </button>
    </div>
    <div class="form-card-body">
    
    <form (ngSubmit)="sauvegarder()" class="main-form">
      <!-- Section: Informations Personnelles -->
      <div class="form-section-wrapper">
        <div class="section-header">
          <span class="section-icon">ğŸ‘¤</span>
          <h3 class="section-title">Informations Personnelles</h3>
        </div>
        <div class="form-grid">
          <div class="form-field">
            <label class="form-label">
              <span class="label-text">Nom</span>
              <span class="required-badge">*</span>
            </label>
            <input 
              type="text" 
              class="form-input"
              [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.nom" 
              name="nom"
              required
              placeholder="Nom de famille">
          </div>
          
          <div class="form-field">
            <label class="form-label">
              <span class="label-text">PrÃ©nom</span>
            </label>
            <input 
              type="text" 
              class="form-input"
              [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.prenom" 
              name="prenom"
              placeholder="PrÃ©nom">
          </div>
          
          <div class="form-field">
            <label class="form-label">
              <span class="label-text">Matricule Interne</span>
            </label>
            <input 
              type="text" 
              class="form-input"
              [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.matricule" 
              name="matricule"
              placeholder="Ex: MO-001">
          </div>
          
          <div class="form-field">
            <label class="form-label">
              <span class="label-text">CIN</span>
              <span class="required-badge">*</span>
            </label>
            <input 
              type="text" 
              class="form-input"
              [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.cin" 
              name="cin"
              required
              placeholder="NumÃ©ro CIN">
          </div>
          
          <div class="form-field">
            <label class="form-label">
              <span class="label-text">TÃ©lÃ©phone</span>
              <span class="required-badge">*</span>
            </label>
            <input 
              type="tel" 
              class="form-input"
              [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.telephone" 
              name="telephone"
              required
              placeholder="+216 XX XXX XXX">
          </div>
          
          <div class="form-field">
            <label class="form-label">
              <span class="label-text">Email</span>
              <span *ngIf="isCreating" class="required-badge">*</span>
            </label>
            <input 
              type="email" 
              class="form-input"
              [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.email" 
              name="email"
              [required]="isCreating"
              placeholder="email@example.com">
            <p class="form-hint" *ngIf="isCreating">
              <span class="hint-icon">âš ï¸</span>
              Obligatoire : Un compte utilisateur sera crÃ©Ã© avec cet email. Le mot de passe par dÃ©faut sera le matricule ou le CIN.
            </p>
          </div>
        </div>
      </div>

      <!-- Section: CompÃ©tence (unique) -->
      <div class="form-section-wrapper">
        <div class="section-header">
          <span class="section-icon">ğŸ¯</span>
          <h3 class="section-title">CompÃ©tence</h3>
        </div>
        <p class="section-description">SÃ©lectionnez la compÃ©tence principale de cet agent (obligatoire)</p>
        <div class="form-field">
          <select 
            [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.competence" 
            name="competence"
            class="form-select"
            required>
            <option value="">-- SÃ©lectionnez une compÃ©tence --</option>
            <option *ngFor="let comp of competencesDisponibles" [value]="comp">{{comp}}</option>
          </select>
        </div>
      </div>

      <!-- Section: Statut -->
      <div class="form-section-wrapper">
        <div class="section-header">
          <span class="section-icon">ğŸ“Š</span>
          <h3 class="section-title">Statut Initial</h3>
        </div>
        <p class="section-description">Le statut sera mis Ã  jour automatiquement lors des affectations</p>
        <div class="form-field">
          <select 
            [(ngModel)]="(isCreating ? nouveauMainDOeuvre : selectedMainDOeuvre)!.disponibilite" 
            name="disponibilite"
            class="form-select">
            <option value="LIBRE">âœ… Libre</option>
            <option value="OCCUPE">ğŸ”„ OccupÃ©</option>
            <option value="ARCHIVE">ğŸ—„ï¸ ArchivÃ©</option>
          </select>
        </div>
      </div>

      <div class="form-actions-modern">
        <button type="button" class="btn-cancel" (click)="annuler()">
          <span class="btn-icon">âœ•</span>
          <span>Annuler</span>
        </button>
        <button type="submit" class="btn-submit">
          <span class="btn-icon">ğŸ’¾</span>
          <span>Enregistrer</span>
        </button>
      </div>
    </form>
    </div>
  </div>

  <!-- Liste des fiches -->
  <div class="main-doeuvre-list">
    <div *ngFor="let md of mainDOeuvreFiltree; trackBy: trackByMainDOeuvreId" class="main-doeuvre-card" [class.archived]="md.disponibilite === 'ARCHIVE'">
      <!-- Card Header -->
      <div class="card-header">
        <div class="header-left-with-photo">
          <div class="agent-photo-wrapper">
            <div class="agent-photo-placeholder">
              <span>{{(md.nom || 'A')[0]}}{{md.prenom ? (md.prenom[0] || '') : ''}}</span>
            </div>
            <div class="status-indicator" [ngClass]="'status-' + (md.disponibilite || 'LIBRE').toLowerCase()"></div>
          </div>
          <div class="agent-info-header">
            <h3>{{md.nom}} {{md.prenom || ''}}</h3>
            <p class="card-subtitle">
              <span class="id-badge">#{{md.id}}</span>
              <span *ngIf="md.matricule" class="matricule-badge">{{md.matricule}}</span>
            </p>
          </div>
        </div>
        <span class="badge" [ngClass]="getBadgeDisponibiliteClass(md.disponibilite)">
          {{getDisponibiliteLabel(md.disponibilite)}}
        </span>
      </div>
      
      <!-- Card Body -->
      <div class="card-body">
        <!-- Informations principales -->
        <div class="info-section">
          <h4 class="section-title">ğŸ“‹ Informations</h4>
          <div class="info-grid-card">
            <div class="info-item-card" *ngIf="md.cin">
              <div class="info-icon">ğŸ†”</div>
              <div class="info-content">
                <strong>CIN</strong>
                <span>{{md.cin}}</span>
              </div>
            </div>
            
            <div class="info-item-card" *ngIf="md.telephone">
              <div class="info-icon">ğŸ“</div>
              <div class="info-content">
                <strong>TÃ©lÃ©phone</strong>
                <span>{{md.telephone}}</span>
              </div>
            </div>

            <div class="info-item-card" *ngIf="md.email">
              <div class="info-icon">ğŸ“§</div>
              <div class="info-content">
                <strong>Email</strong>
                <span>{{md.email}}</span>
                <span class="badge-compte">âœ“ Compte crÃ©Ã©</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- CompÃ©tence -->
        <div *ngIf="md.competence" class="info-section">
          <h4 class="section-title">ğŸ¯ CompÃ©tence</h4>
          <div class="tags-list">
            <span class="tag tag-competence">
              <span class="tag-icon">âœ“</span>
              {{md.competence}}
            </span>
          </div>
        </div>

        <!-- Historique supprimÃ© selon le nouveau schÃ©ma XSD -->
      </div>

      <!-- Card Actions -->
      <div class="card-actions">
        <button 
          class="btn-action btn-edit" 
          (click)="editer(md)" 
          [attr.aria-label]="'Modifier la fiche de ' + md.nom"
          [disabled]="md.disponibilite === 'ARCHIVE'">
          <span class="btn-icon">âœï¸</span>
          <span class="btn-text">Modifier</span>
        </button>
        <button 
          class="btn-action btn-archive" 
          (click)="archiver(md)" 
          [attr.aria-label]="'Archiver la fiche de ' + md.nom"
          [disabled]="md.disponibilite === 'ARCHIVE'">
          <span class="btn-icon">ğŸ—„ï¸</span>
          <span class="btn-text">Archiver</span>
        </button>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="mainDOeuvreFiltree.length === 0" class="empty-state">
      <div class="empty-icon">ğŸ‘·</div>
      <h3>Aucune fiche de main d'Å“uvre trouvÃ©e</h3>
      <p class="empty-message">
        CrÃ©ez votre premiÃ¨re fiche ou modifiez vos filtres de recherche.
      </p>
      <button class="btn-primary" (click)="creerNouveau()">
        â• CrÃ©er une fiche
      </button>
    </div>
  </div>

  <!-- Modal Historique supprimÃ© car historiqueInterventions n'est plus dans le schÃ©ma XSD -->
</div>
