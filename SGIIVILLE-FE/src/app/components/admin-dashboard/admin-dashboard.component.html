<div class="admin-dashboard">
  <header>
    <h1>Dashboard Administrateur</h1>
    <div class="header-actions">
      <!-- IcÃ´ne notifications -->
      <div class="notification-bell" (click)="toggleNotificationsDropdown()">
        ğŸ””
        <span class="badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>

        <!-- Dropdown notifications -->
        <div class="notifications-dropdown" *ngIf="showNotificationsDropdown" (click)="$event.stopPropagation()">
          <div class="dropdown-header">
            <h4>Notifications</h4>
            <span class="count">{{ unreadCount }} non lue(s)</span>
          </div>
          <div class="notifications-list">
            <div *ngIf="notifications.length === 0" class="empty-state">
              Aucune notification
            </div>
            <div *ngFor="let notif of notifications"
                 class="notification-item"
                 [class.unread]="!notif.readable"
                 (click)="markAsRead(notif)">
              <div class="notif-icon">
                {{ notif.readable ? 'ğŸ“¬' : 'ğŸ“­' }}
              </div>
              <div class="notif-content">
                <p class="notif-message">{{ notif.message }}</p>
                <span class="notif-time">{{ formatNotificationDate(notif.createdAt) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <button class="btn-logout" (click)="logout()">DÃ©connexion</button>
    </div>
  </header>

  <!-- Carte Interventions en Cours -->
  <div class="interventions-card">
    <div class="card-header">
      <h2>ğŸ—ºï¸ Carte des Interventions en Cours</h2>
      <span class="total-count">Total: {{ interventionsEnCours.length }}</span>
    </div>

    <!-- LÃ©gende -->
    <div class="map-legend">
      <div class="legend-item">
        <div class="legend-marker en-cours"></div>
        <span>ğŸ”µ En cours</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker en-attente"></div>
        <span>ğŸŸ  En attente</span>
      </div>
    </div>

    <!-- Carte Leaflet -->
    <div id="mapInterventionsAdmin" class="interventions-map"></div>

    <div class="no-interventions" *ngIf="interventionsEnCours.length === 0">
      <div class="empty-icon">ğŸ—ºï¸</div>
      <p>Aucune intervention en cours avec localisation</p>
    </div>
  </div>

  <div class="actions">
    <button class="btn-create" [class.btn-cancel]="showCreateTechForm" (click)="showCreateTechForm = !showCreateTechForm">
      <span class="btn-icon">{{ showCreateTechForm ? 'âœ•' : 'ğŸ‘¤' }}</span>
      {{ showCreateTechForm ? 'Annuler' : 'Nouveau Technicien' }}
    </button>
    <button class="btn-create" [class.btn-cancel]="showCreateChefForm" (click)="showCreateChefForm = !showCreateChefForm">
      <span class="btn-icon">{{ showCreateChefForm ? 'âœ•' : 'ğŸ‘”' }}</span>
      {{ showCreateChefForm ? 'Annuler' : 'Nouveau Chef de Service' }}
    </button>
  </div>

  <!-- Formulaire Technicien -->
  <div class="form-container" *ngIf="showCreateTechForm">
    <h2>CrÃ©er un Technicien</h2>
    <form (ngSubmit)="createTechnicien()">
      <div class="form-group">
        <label>Nom:</label>
        <input type="text" [(ngModel)]="newTechnicien.nom" name="nom" required>
      </div>
      <div class="form-group">
        <label>Email:</label>
        <input type="email" [(ngModel)]="newTechnicien.email" name="email" required>
      </div>
      <div class="form-group">
        <label>Mot de passe:</label>
        <input type="password" [(ngModel)]="newTechnicien.motDePasse" name="password" required>
      </div>
      <div class="form-group">
        <label>CompÃ©tences:</label>
        <div class="competences-input">
          <input type="text" [(ngModel)]="competenceInput" name="comp" placeholder="Ajouter une compÃ©tence">
          <button type="button" (click)="addCompetence()">Ajouter</button>
        </div>
        <div class="competences-list">
          <span *ngFor="let comp of newTechnicien.competences; let i = index" class="chip">
            {{comp}} <button type="button" (click)="removeCompetence(i)">Ã—</button>
          </span>
        </div>
      </div>
      <button type="submit" class="btn-success">CrÃ©er Technicien</button>
    </form>
  </div>

  <!-- Formulaire Chef de Service -->
  <div class="form-container" *ngIf="showCreateChefForm">
    <h2>CrÃ©er un Chef de Service</h2>
    <form (ngSubmit)="createChef()">
      <div class="form-group">
        <label>Nom:</label>
        <input type="text" [(ngModel)]="newChef.nom" name="nomChef" required>
      </div>
      <div class="form-group">
        <label>Email:</label>
        <input type="email" [(ngModel)]="newChef.email" name="emailChef" required>
      </div>
      <div class="form-group">
        <label>Mot de passe:</label>
        <input type="password" [(ngModel)]="newChef.motDePasse" name="passwordChef" required>
      </div>
      <div class="form-group">
        <label>DÃ©partement:</label>
        <input type="text" [(ngModel)]="newChef.departement" name="dept" required>
      </div>
      <button type="submit" class="btn-success">CrÃ©er Chef de Service</button>
    </form>
  </div>

  <!-- Liste des utilisateurs -->
  <div class="users-list">
    <div class="users-header">
      <h2>ğŸ‘¥ Gestion des Utilisateurs</h2>
      <span class="users-count">Total: {{users.length}}</span>
    </div>
    <div class="table-wrapper">
      <table class="modern-table">
        <thead>
          <tr>
            <th>ğŸ“Œ ID</th>
            <th>ğŸ‘¤ Nom</th>
            <th>ğŸ“§ Email</th>
            <th>ğŸ·ï¸ RÃ´le</th>
            <th>âš™ï¸ Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users" class="user-row">
            <td><strong class="user-id">#{{user.id}}</strong></td>
            <td class="user-name">{{user.nom}}</td>
            <td class="user-email">{{user.email}}</td>
            <td><span class="role-badge" [ngClass]="getRoleClass(user.role)">{{user.role}}</span></td>
            <td>
              <button class="btn-delete" (click)="deleteUser(user.id)">
                ğŸ—‘ï¸ Supprimer
              </button>
            </td>
          </tr>
          <tr *ngIf="users.length === 0">
            <td colspan="5" class="no-data">
              <div class="empty-state">
                <div class="empty-icon">ğŸ‘¥</div>
                <p>Aucun utilisateur trouvÃ©</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <!-- SECTION GESTION DES DEMANDES DE RESSOURCES -->
<div class="section demande-ressource-section">
  <div class="section-header">
    <h2>ğŸ“¦ Gestion des demandes de ressources</h2>
    <div class="stats-badge">
      <span class="stat-item pending" (click)="demandeRessourceFilter = 'EN_ATTENTE'">
  â³ {{ demandesEnAttenteCount }} en attente
</span>
      <span class="stat-item success" (click)="demandeRessourceFilter = 'TRAITEES'">
  âœ… {{ demandesAccepteesCount }} acceptÃ©es
</span>
      <span class="stat-item error" (click)="demandeRessourceFilter = 'TRAITEES'">
  âŒ {{ demandesRefuseesCount }} refusÃ©es
</span>
    </div>
  </div>

  <!-- Filtres -->
  <div class="filter-tabs">
    <button class="filter-tab"
            [class.active]="demandeRessourceFilter === 'TOUTES'"
            (click)="demandeRessourceFilter = 'TOUTES'">
      Toutes ({{ demandesRessources.length }})
    </button>
    <button class="filter-tab"
            [class.active]="demandeRessourceFilter === 'EN_ATTENTE'"
            (click)="demandeRessourceFilter = 'EN_ATTENTE'">
â³ En attente ({{ demandesEnAttenteCount }})    </button>
    <button class="filter-tab"
            [class.active]="demandeRessourceFilter === 'TRAITEES'"
            (click)="demandeRessourceFilter = 'TRAITEES'">
â³ En attente ({{ demandesEnAttenteCount }})    </button>
  </div>

  <!-- Tableau des demandes -->
  <div class="table-container">
    <table class="modern-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ressource</th>
          <th>QuantitÃ©</th>
          <th>Budget</th>
          <th>Chef</th>
          <th>Date</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let demande of getDemandesFiltrees()">
          <td><strong>#{{ demande.id }}</strong></td>
          <td class="designation-cell">
            <strong>{{ demande.designation }}</strong><br>
            <small class="text-muted">{{ demande.justification | slice:0:60 }}...</small>
          </td>
          <td>{{ demande.quantite }} unitÃ©s</td>
          <td>{{ demande.budget | currency:'DT ' }}</td>
          <td>Chef #{{ demande.chefId }}</td>
          <td>{{ demande.dateDemande | date:'dd/MM' }}</td>
          <td>
            <span class="status" [ngClass]="getEtatBadgeClassDemande(demande.etat)">
              {{ getEtatTextDemande(demande.etat) }}
            </span>
          </td>
          <td class="actions-cell">
            <div class="action-buttons" *ngIf="demande.etat === 'EN_ATTENTE_ADMIN'">
              <button class="btn-small success"
                      (click)="accepterDemandeRessource(demande)"
                      title="Accepter et ajouter au stock">
                âœ… Accepter
              </button>
              <button class="btn-small danger"
                      (click)="refuserDemandeRessource(demande)"
                      title="Refuser avec motif">
                âŒ Refuser
              </button>
              <button class="btn-small info"
                      (click)="voirDetailsDemandeRessourceAdmin(demande)"
                      title="Voir dÃ©tails">
                ğŸ‘ï¸ DÃ©tails
              </button>
            </div>
            <div *ngIf="demande.etat !== 'EN_ATTENTE_ADMIN'">
              <span class="text-success" *ngIf="demande.etat === 'ACCEPTEE'">âœ… AcceptÃ©e</span>
              <span class="text-danger" *ngIf="demande.etat === 'REFUSEE'">âŒ RefusÃ©e</span>
              <button class="btn-small view"
                      (click)="voirDetailsDemandeRessourceAdmin(demande)">
                DÃ©tails
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="getDemandesFiltrees().length === 0">
          <td colspan="8" class="no-data">
            <div style="padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
              <p>Aucune demande de ressource Ã  afficher</p>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- MODAL REFUS DEMANDE RESSOURCE -->
<div class="modal-overlay" *ngIf="showRefusRessourceModal" (click)="closeRefusRessourceModal()">
  <div class="modal-content" (click)="$event.stopPropagation()" style="max-width: 500px;">
    <button class="close-btn" (click)="closeRefusRessourceModal()">Ã—</button>
    <h2>âŒ Refuser la demande #{{ selectedDemandeRessource?.id }}</h2>

    <div class="demande-info">
      <p><strong>Ressource:</strong> {{ selectedDemandeRessource?.designation }}</p>
      <p><strong>QuantitÃ©:</strong> {{ selectedDemandeRessource?.quantite }} unitÃ©s</p>
      <p><strong>Budget:</strong> {{ selectedDemandeRessource?.budget }} DT</p>
      <p><strong>Chef:</strong> #{{ selectedDemandeRessource?.chefId }}</p>
    </div>

    <div class="form-group">
      <label>Motif du refus *</label>
      <textarea [(ngModel)]="motifRefusRessource"
                placeholder="Expliquez clairement pourquoi cette demande est refusÃ©e..."
                rows="4" required></textarea>
      <small class="form-hint">Ce message sera envoyÃ© au chef de service</small>
    </div>

    <div class="form-actions">
      <button type="button" class="action-btn secondary"
              (click)="closeRefusRessourceModal()">
        Annuler
      </button>
      <button type="button" class="action-btn danger large"
              (click)="confirmerRefusRessource()"
              [disabled]="!motifRefusRessource || motifRefusRessource.length < 10">
        âŒ Confirmer le refus
      </button>
    </div>
  </div>
</div>


</div>