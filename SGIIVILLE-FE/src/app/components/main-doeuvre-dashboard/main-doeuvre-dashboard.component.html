<!-- main-doeuvre-dashboard.component.html -->
<div class="main-doeuvre-dashboard" role="main" aria-label="Tableau de bord main d'Å“uvre">

  <!-- HEADER -->
  <header class="page-header" role="banner">
    <div>
      <h1>ğŸ‘· Tableau de Bord Main d'Å’uvre</h1>
      <p class="page-subtitle" *ngIf="profil" aria-live="polite">
        Bienvenue, <strong>{{ profil.nom }} {{ profil.prenom || '' }}</strong>
        <span *ngIf="profil.competence"> - {{ profil.competence }}</span>
      </p>
    </div>
    <nav class="header-actions" aria-label="Actions du header">
      <button
        type="button"
        class="btn-refresh"
        (click)="loadMyTaches()"
        [attr.aria-label]="'Actualiser la liste des tÃ¢ches'"
        [attr.aria-busy]="loading">
        <span aria-hidden="true">ğŸ”„</span>
        <span>Actualiser</span>
      </button>
      <button
        type="button"
        class="btn-secondary"
        (click)="deconnexion()"
        [attr.aria-label]="'Se dÃ©connecter'">
        <span aria-hidden="true">ğŸšª</span>
        <span>DÃ©connexion</span>
      </button>
    </nav>
  </header>

  <!-- STATISTIQUES -->
  <section class="stats-section" aria-labelledby="stats-title">
    <h2 id="stats-title" class="sr-only">Statistiques des tÃ¢ches</h2>
    <div class="stats-cards-container" role="list">
      <article class="stat-card stat-total" role="listitem">
        <div class="stat-icon" aria-hidden="true">ğŸ“Š</div>
        <div class="stat-content">
          <p class="stat-value">{{ taches.length }}</p>
          <p class="stat-label">Total TÃ¢ches</p>
        </div>
      </article>

      <article class="stat-card stat-a-faire" role="listitem" *ngIf="stats.aFaire > 0">
        <div class="stat-icon" aria-hidden="true">â³</div>
        <div class="stat-content">
          <p class="stat-value">{{ stats.aFaire }}</p>
          <p class="stat-label">Ã€ Faire</p>
        </div>
      </article>

      <article class="stat-card stat-en-cours" role="listitem" *ngIf="stats.enCours > 0">
        <div class="stat-icon" aria-hidden="true">ğŸ”§</div>
        <div class="stat-content">
          <p class="stat-value">{{ stats.enCours }}</p>
          <p class="stat-label">En Cours</p>
        </div>
      </article>

      <article class="stat-card stat-terminee" role="listitem" *ngIf="stats.terminees > 0">
        <div class="stat-icon" aria-hidden="true">âœ…</div>
        <div class="stat-content">
          <p class="stat-value">{{ stats.terminees }}</p>
          <p class="stat-label">TerminÃ©es</p>
        </div>
      </article>

      <article class="stat-card stat-verifiee" role="listitem" *ngIf="stats.verifiees > 0">
        <div class="stat-icon" aria-hidden="true">âœ”ï¸</div>
        <div class="stat-content">
          <p class="stat-value">{{ stats.verifiees }}</p>
          <p class="stat-label">VÃ©rifiÃ©es</p>
        </div>
      </article>
    </div>
  </section>

  <!-- FILTRES -->
  <section class="filters-section" aria-labelledby="filters-title">
    <div class="section-title">
      <h2 id="filters-title">ğŸ” Filtres et Recherche</h2>
    </div>
    <div class="filters-grid">
      <div class="search-box">
        <label for="search-input" class="sr-only">Rechercher une tÃ¢che</label>
        <input
          id="search-input"
          type="text"
          [(ngModel)]="recherche"
          (input)="appliquerFiltres()"
          placeholder="Rechercher par libellÃ©, description..."
          aria-label="Rechercher une tÃ¢che"
          autocomplete="off">
      </div>

      <div>
        <label for="filter-etat" class="sr-only">Filtrer par Ã©tat</label>
        <select
          id="filter-etat"
          [(ngModel)]="filtreEtat"
          (change)="loadMyTaches()"
          aria-label="Filtrer par Ã©tat">
          <option value="">Tous les Ã©tats</option>
          <option value="A_FAIRE">â³ Ã€ faire</option>
          <option value="EN_COURS">ğŸ”§ En cours</option>
          <option value="TERMINEE">âœ… TerminÃ©e</option>
          <option value="VERIFIEE">âœ”ï¸ VÃ©rifiÃ©e</option>
          <option value="SUSPENDUE">â¸ï¸ Suspendue</option>
          <option value="REPORTEE">ğŸ“… ReportÃ©e</option>
        </select>
      </div>
    </div>
  </section>

  <!-- LISTE DES TÃ‚CHES -->
  <section class="taches-section" aria-labelledby="taches-title">
    <div class="section-title">
      <h2 id="taches-title">ğŸ“‹ Mes TÃ¢ches AssignÃ©es</h2>
      <span class="count-badge" [attr.aria-label]="'Nombre de tÃ¢ches: ' + tachesFiltrees.length">
        {{ tachesFiltrees.length }} tÃ¢che(s)
      </span>
    </div>

    <!-- Ã‰tat de chargement -->
    <div *ngIf="loading" class="loading-state" role="status" aria-live="polite">
      <p>Chargement des tÃ¢ches...</p>
    </div>

    <!-- Ã‰tat vide -->
    <div *ngIf="!loading && tachesFiltrees.length === 0" class="empty-state" role="status">
      <p aria-live="polite">ğŸ“­ Aucune tÃ¢che trouvÃ©e</p>
      <p class="empty-subtitle">
        <span *ngIf="recherche || filtreEtat">
          Aucune tÃ¢che ne correspond Ã  vos critÃ¨res de recherche.
        </span>
        <span *ngIf="!recherche && !filtreEtat">
          Aucune tÃ¢che ne vous est actuellement assignÃ©e.
        </span>
      </p>
    </div>

    <!-- Liste des tÃ¢ches -->
    <div *ngIf="!loading && tachesFiltrees.length > 0" class="taches-list" role="list">
      <article
        *ngFor="let tache of tachesFiltrees; trackBy: trackByTacheId"
        class="tache-card"
        role="listitem"
        [attr.aria-label]="'TÃ¢che: ' + tache.libelle + ', Ã‰tat: ' + getEtatTacheLabel(tache.etat)"
        [class]="getEtatTacheClass(tache.etat)">

        <!-- En-tÃªte de la tÃ¢che -->
        <div class="card-header">
          <div class="card-title">
            <h3>{{ tache.libelle }}</h3>
            <span class="tache-id" aria-label="NumÃ©ro de tÃ¢che">#{{ tache.id }}</span>
          </div>
          <div class="card-badges" role="group" aria-label="Badges d'Ã©tat">
            <span class="badge-etat" [attr.aria-label]="'Ã‰tat: ' + getEtatTacheLabel(tache.etat)">
              {{ getEtatTacheLabel(tache.etat) }}
            </span>
          </div>
        </div>

        <!-- Corps de la tÃ¢che -->
        <div class="card-body">
          <!-- Description -->
          <div class="tache-description" *ngIf="tache.description">
            <p>{{ tache.description }}</p>
          </div>

          <!-- Informations de l'intervention -->
          <div class="intervention-info" *ngIf="tache.intervention">
            <div class="info-row">
              <div class="info-item">
                <strong>Intervention:</strong>
                <a (click)="voirDetailsIntervention(tache.interventionId)"
                   class="intervention-link"
                   [attr.aria-label]="'Voir les dÃ©tails de l\'intervention ' + tache.interventionId">
                  #{{ tache.interventionId }} - {{ tache.intervention.description || 'Sans description' }}
                </a>
              </div>
              <div class="info-item" *ngIf="tache.intervention.typeIntervention">
                <strong>Type:</strong>
                <span>{{ tache.intervention.typeIntervention }}</span>
              </div>
              <div class="info-item" *ngIf="tache.intervention.priorite">
                <strong>PrioritÃ©:</strong>
                <span class="priorite" [class]="'priorite-' + tache.intervention.priorite.toLowerCase()">
                  {{ tache.intervention.priorite }}
                </span>
              </div>
            </div>
          </div>

          <!-- MÃ©tadonnÃ©es de la tÃ¢che -->
          <div class="tache-metadata">
            <div class="metadata-item" *ngIf="tache.dateCreation">
              <strong>CrÃ©Ã©e le:</strong>
              <time [attr.datetime]="tache.dateCreation">{{ formatDate(tache.dateCreation) }}</time>
            </div>
            <div class="metadata-item" *ngIf="tache.dateDebut">
              <strong>DÃ©butÃ©e le:</strong>
              <time [attr.datetime]="tache.dateDebut">{{ formatDate(tache.dateDebut) }}</time>
            </div>
            <div class="metadata-item" *ngIf="tache.dateFin">
              <strong>TerminÃ©e le:</strong>
              <time [attr.datetime]="tache.dateFin">{{ formatDate(tache.dateFin) }}</time>
            </div>
            <div class="metadata-item" *ngIf="tache.tempsPasseMinutes">
              <strong>Temps passÃ©:</strong>
              <span>{{ formatTemps(tache.tempsPasseMinutes) }}</span>
            </div>
          </div>

          <!-- Commentaires -->
          <div class="commentaires-section" *ngIf="tache.commentaireMainDOeuvre">
            <h4>ğŸ“ Mon commentaire</h4>
            <p class="commentaire">{{ tache.commentaireMainDOeuvre }}</p>
          </div>

          <!-- Barre de progression d'Ã©tat -->
          <div class="tache-progress-bar" role="progressbar"
               [attr.aria-valuenow]="getEtatProgress(tache.etat)"
               aria-valuemin="0"
               aria-valuemax="100"
               [attr.aria-label]="'Progression de la tÃ¢che: ' + getEtatProgress(tache.etat) + '%'">
            <div class="progress-track">
              <div class="progress-fill" [style.width.%]="getEtatProgress(tache.etat)"></div>
            </div>
            <div class="progress-steps">
              <div class="progress-step"
                   [class.active]="isEtatActive(tache.etat, 'A_FAIRE')"
                   [class.completed]="isEtatCompleted(tache.etat, 'A_FAIRE')">
                <div class="step-indicator">
                  <span class="step-number">1</span>
                </div>
                <span class="step-label">Ã€ faire</span>
              </div>
              <div class="progress-step"
                   [class.active]="isEtatActive(tache.etat, 'EN_COURS')"
                   [class.completed]="isEtatCompleted(tache.etat, 'EN_COURS')">
                <div class="step-indicator">
                  <span class="step-number">2</span>
                </div>
                <span class="step-label">En cours</span>
              </div>
              <div class="progress-step"
                   [class.active]="isEtatActive(tache.etat, 'TERMINEE')"
                   [class.completed]="isEtatCompleted(tache.etat, 'TERMINEE')">
                <div class="step-indicator">
                  <span class="step-number">3</span>
                </div>
                <span class="step-label">TerminÃ©e</span>
              </div>
              <div class="progress-step"
                   [class.active]="isEtatActive(tache.etat, 'VERIFIEE')"
                   [class.completed]="isEtatCompleted(tache.etat, 'VERIFIEE')">
                <div class="step-indicator">
                  <span class="step-number">4</span>
                </div>
                <span class="step-label">VÃ©rifiÃ©e</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions selon l'Ã©tat -->
        <div class="card-actions">
          <!-- Ã‰tat A_FAIRE -->
          <div *ngIf="tache.etat === 'A_FAIRE'" class="actions-group">
            <button
              type="button"
              class="btn-commencer"
              (click)="commencerTache(tache)"
              [attr.aria-label]="'Commencer la tÃ¢che: ' + tache.libelle">
              <span aria-hidden="true">â–¶ï¸</span>
              <span>Commencer</span>
            </button>
            <button
              type="button"
              class="btn-commenter"
              (click)="ouvrirModalCommenter(tache)"
              [attr.aria-label]="'Ajouter un commentaire Ã  la tÃ¢che: ' + tache.libelle">
              <span aria-hidden="true">ğŸ’¬</span>
              <span>Commenter</span>
            </button>
            <button
              type="button"
              class="btn-reporter"
              (click)="ouvrirModalReporter(tache)"
              [attr.aria-label]="'Reporter la tÃ¢che: ' + tache.libelle">
              <span aria-hidden="true">ğŸ“…</span>
              <span>Reporter</span>
            </button>
          </div>

          <!-- Ã‰tat EN_COURS -->
          <div *ngIf="tache.etat === 'EN_COURS'" class="actions-group">
            <button
              type="button"
              class="btn-terminer"
              (click)="ouvrirModalTerminer(tache)"
              [attr.aria-label]="'Terminer la tÃ¢che: ' + tache.libelle">
              <span aria-hidden="true">âœ…</span>
              <span>Terminer</span>
            </button>
            <button
              type="button"
              class="btn-commenter"
              (click)="ouvrirModalCommenter(tache)"
              [attr.aria-label]="'Ajouter un commentaire Ã  la tÃ¢che: ' + tache.libelle">
              <span aria-hidden="true">ğŸ’¬</span>
              <span>Commenter</span>
            </button>
            <button
              type="button"
              class="btn-suspendre"
              (click)="ouvrirModalSuspendre(tache)"
              [attr.aria-label]="'Suspendre la tÃ¢che: ' + tache.libelle">
              <span aria-hidden="true">â¸ï¸</span>
              <span>Suspendre</span>
            </button>
          </div>

          <!-- Ã‰tat TERMINEE -->
          <div *ngIf="tache.etat === 'TERMINEE'" class="actions-group">
            <span class="status-message">âœ… En attente de vÃ©rification par le technicien</span>
            <button
              type="button"
              class="btn-commenter"
              (click)="ouvrirModalCommenter(tache)"
              [attr.aria-label]="'Ajouter un commentaire Ã  la tÃ¢che: ' + tache.libelle">
              <span aria-hidden="true">ğŸ’¬</span>
              <span>Commenter</span>
            </button>
          </div>

          <!-- Ã‰tat VERIFIEE -->
          <div *ngIf="tache.etat === 'VERIFIEE'" class="actions-group">
            <span class="status-message">âœ”ï¸ TÃ¢che vÃ©rifiÃ©e et validÃ©e</span>
          </div>

          <!-- Ã‰tat SUSPENDUE -->
          <div *ngIf="tache.etat === 'SUSPENDUE'" class="actions-group">
            <button
              type="button"
              class="btn-reprendre"
              (click)="reprendreTache(tache)"
              [attr.aria-label]="'Reprendre la tÃ¢che: ' + tache.libelle">
              <span aria-hidden="true">â–¶ï¸</span>
              <span>Reprendre</span>
            </button>
            <button
              type="button"
              class="btn-commenter"
              (click)="ouvrirModalCommenter(tache)"
              [attr.aria-label]="'Ajouter un commentaire Ã  la tÃ¢che: ' + tache.libelle">
              <span aria-hidden="true">ğŸ’¬</span>
              <span>Commenter</span>
            </button>
          </div>

          <!-- Ã‰tat REPORTEE -->
          <div *ngIf="tache.etat === 'REPORTEE'" class="actions-group">
            <span class="status-message">ğŸ“… TÃ¢che reportÃ©e</span>
            <button
              type="button"
              class="btn-reprendre"
              (click)="commencerTache(tache)"
              [attr.aria-label]="'Commencer la tÃ¢che: ' + tache.libelle">
              <span aria-hidden="true">â–¶ï¸</span>
              <span>RedÃ©marrer</span>
            </button>
          </div>
        </div>
      </article>
    </div>
  </section>

  <!-- ========== MODALS ========== -->

  <!-- Modal Terminer TÃ¢che -->
  <div *ngIf="modalAction === 'terminer' && selectedTache"
       class="modal-overlay"
       role="dialog"
       aria-labelledby="modal-terminer-title"
       aria-modal="true"
       (click)="fermerModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3 id="modal-terminer-title">âœ… Terminer la tÃ¢che</h3>
      <p><strong>{{ selectedTache.libelle }}</strong></p>

      <form (ngSubmit)="terminerTache()">
        <div class="form-group">
          <label for="commentaire-terminer">Commentaire (obligatoire)</label>
          <textarea
            id="commentaire-terminer"
            [(ngModel)]="terminerTacheRequest.commentaire"
            name="commentaire"
            placeholder="DÃ©crivez le travail effectuÃ©..."
            rows="4"
            required></textarea>
        </div>

        <div class="form-group">
          <label for="temps-passe">Temps passÃ© (en minutes)</label>
          <input
            id="temps-passe"
            type="number"
            [(ngModel)]="terminerTacheRequest.tempsPasseMinutes"
            name="tempsPasseMinutes"
            placeholder="Ex: 120"
            min="1"
            step="1"
            required>
        </div>

        <div class="modal-actions">
          <button
            type="button"
            class="btn-secondary"
            (click)="fermerModal()">
            Annuler
          </button>
          <button
            type="submit"
            class="btn-success"
            [disabled]="isSubmitting">
            {{ isSubmitting ? 'â³ En cours...' : 'âœ… Terminer la tÃ¢che' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Commenter -->
  <div *ngIf="modalAction === 'commenter' && selectedTache"
       class="modal-overlay"
       role="dialog"
       aria-labelledby="modal-commenter-title"
       aria-modal="true"
       (click)="fermerModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3 id="modal-commenter-title">ğŸ’¬ Ajouter un commentaire</h3>
      <p><strong>{{ selectedTache.libelle }}</strong></p>

      <form (ngSubmit)="ajouterCommentaire()">
        <div class="form-group">
          <label for="commentaire">Commentaire</label>
          <textarea
            id="commentaire"
            [(ngModel)]="commentaireTache"
            name="commentaire"
            placeholder="Ajoutez vos observations..."
            rows="4"
            required></textarea>
        </div>

        <div class="modal-actions">
          <button
            type="button"
            class="btn-secondary"
            (click)="fermerModal()">
            Annuler
          </button>
          <button
            type="submit"
            class="btn-primary">
            ğŸ’¬ Enregistrer
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Reporter -->
  <div *ngIf="modalAction === 'reporter' && selectedTache"
       class="modal-overlay"
       role="dialog"
       aria-labelledby="modal-reporter-title"
       aria-modal="true"
       (click)="fermerModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3 id="modal-reporter-title">ğŸ“… Reporter la tÃ¢che</h3>
      <p><strong>{{ selectedTache.libelle }}</strong></p>

      <form (ngSubmit)="reporterTache()">
        <div class="form-group">
          <label for="raison-report">Raison du report (obligatoire)</label>
          <textarea
            id="raison-report"
            [(ngModel)]="raisonReport"
            name="raisonReport"
            placeholder="Expliquez pourquoi vous reportez cette tÃ¢che..."
            rows="4"
            required></textarea>
        </div>

        <div class="modal-actions">
          <button
            type="button"
            class="btn-secondary"
            (click)="fermerModal()">
            Annuler
          </button>
          <button
            type="submit"
            class="btn-warning">
            ğŸ“… Reporter
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Suspendre -->
  <div *ngIf="modalAction === 'suspendre' && selectedTache"
       class="modal-overlay"
       role="dialog"
       aria-labelledby="modal-suspendre-title"
       aria-modal="true"
       (click)="fermerModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3 id="modal-suspendre-title">â¸ï¸ Suspendre la tÃ¢che</h3>
      <p><strong>{{ selectedTache.libelle }}</strong></p>

      <form (ngSubmit)="suspendreTache()">
        <div class="form-group">
          <label for="raison-suspension">Raison de la suspension (obligatoire)</label>
          <textarea
            id="raison-suspension"
            [(ngModel)]="raisonSuspension"
            name="raisonSuspension"
            placeholder="Expliquez pourquoi vous suspendez cette tÃ¢che..."
            rows="4"
            required></textarea>
        </div>

        <div class="modal-actions">
          <button
            type="button"
            class="btn-secondary"
            (click)="fermerModal()">
            Annuler
          </button>
          <button
            type="submit"
            class="btn-warning">
            â¸ï¸ Suspendre
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
