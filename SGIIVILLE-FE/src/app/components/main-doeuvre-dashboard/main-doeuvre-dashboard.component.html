<!-- ============================================
     DASHBOARD MAIN-D'≈íUVRE - Design Expert UI/UX
     Interface professionnelle et moderne
     ============================================ -->

<div class="main-doeuvre-dashboard" role="main" aria-label="Tableau de bord main-d'≈ìuvre">
  
  <!-- ========== HEADER ========== -->
  <header class="page-header" role="banner">
    <div>
      <h1>üë∑ Tableau de Bord</h1>
      <p class="page-subtitle" *ngIf="profil" aria-live="polite">
        Bienvenue, <strong>{{ profil.nom }} {{ profil.prenom || '' }}</strong>
      </p>
      <p class="page-subtitle" *ngIf="!profil">
        Chargement du profil...
      </p>
    </div>
    <nav class="header-actions" aria-label="Actions du header">
      <!-- Notifications -->
      <div class="notifications-container" (click)="$event.stopPropagation()">
        <button 
          type="button"
          class="btn-notifications" 
          [class.has-unread]="unreadCount > 0"
          [class.active]="showNotifications"
          (click)="toggleNotifications($event)"
          [attr.aria-label]="'Notifications' + (unreadCount > 0 ? ': ' + unreadCount + ' non lues' : '')"
          [attr.aria-expanded]="showNotifications">
          <span class="notification-icon" aria-hidden="true">üîî</span>
          <span class="notification-badge" *ngIf="unreadCount > 0" [attr.aria-label]="unreadCount + ' notifications non lues'">
            {{ unreadCount > 99 ? '99+' : unreadCount }}
          </span>
        </button>
        
        <!-- Dropdown notifications -->
        <div class="notifications-dropdown" 
             *ngIf="showNotifications" 
             (click)="$event.stopPropagation()">
          <div class="notifications-header">
            <h3>Notifications</h3>
            <button 
              type="button"
              class="btn-mark-all-read" 
              *ngIf="unreadCount > 0"
              (click)="markAllAsRead()"
              [attr.aria-label]="'Marquer toutes comme lues'">
              Tout marquer comme lu
            </button>
          </div>
          <div class="notifications-list" role="list">
            <!-- Debug temporaire - √† retirer en production -->
            <!-- <div style="padding: 8px; background: #f0f0f0; font-size: 11px; border-bottom: 1px solid #ddd;">
              Debug: {{ notifications.length }} notification(s) | Non lues: {{ unreadCount }}
            </div> -->
            
            <ng-container *ngIf="notifications.length > 0; else noNotifications">
              <div 
                *ngFor="let notification of notifications; trackBy: trackByNotificationId" 
                class="notification-item"
                [class.unread]="!notification.readable"
                role="listitem"
                (click)="markAsRead(notification)"
                [attr.aria-label]="'Notification: ' + notification.message">
                <div class="notification-content">
                  <p class="notification-message">{{ notification.message }}</p>
                  <span class="notification-time">{{ formatNotificationDate(notification.createdAt) }}</span>
                </div>
                <span class="notification-dot" *ngIf="!notification.readable" aria-hidden="true"></span>
              </div>
            </ng-container>
            
            <ng-template #noNotifications>
              <div class="notifications-empty">
                <p>üì≠ Aucune notification</p>
                <p class="notifications-empty-hint">Vous serez notifi√© lorsque de nouvelles t√¢ches vous seront assign√©es.</p>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
      
      <button 
        type="button"
        class="btn-refresh" 
        (click)="loadMyInterventions()"
        [attr.aria-label]="'Actualiser la liste des interventions'"
        [attr.aria-busy]="loading">
        <span aria-hidden="true">üîÑ</span>
        <span>Actualiser</span>
      </button>
      <button 
        type="button"
        class="btn-secondary" 
        (click)="deconnexion()"
        [attr.aria-label]="'Se d√©connecter'">
        <span aria-hidden="true">üö™</span>
        <span>D√©connexion</span>
      </button>
    </nav>
  </header>

  <!-- ========== STATISTIQUES GLOBALES ========== -->
  <section class="stats-section" aria-labelledby="stats-title" *ngIf="statistiques">
    <h2 id="stats-title" class="sr-only">Statistiques globales</h2>
    <div class="stats-cards-container" role="list">
      <article class="stat-card stat-total" role="listitem">
        <div class="stat-icon" aria-hidden="true">üìä</div>
        <div class="stat-content">
          <p class="stat-value" [attr.aria-label]="'Total interventions: ' + statistiques.totalInterventions">
            {{ statistiques.totalInterventions }}
          </p>
          <p class="stat-label">Total Interventions</p>
        </div>
      </article>
      
      <article class="stat-card stat-terminees" role="listitem">
        <div class="stat-icon" aria-hidden="true">‚úÖ</div>
        <div class="stat-content">
          <p class="stat-value" [attr.aria-label]="'Interventions termin√©es: ' + statistiques.interventionsTerminees">
            {{ statistiques.interventionsTerminees }}
          </p>
          <p class="stat-label">Termin√©es</p>
        </div>
      </article>
      
      <article class="stat-card stat-taux" role="listitem">
        <div class="stat-icon" aria-hidden="true">üìà</div>
        <div class="stat-content">
          <p class="stat-value" [attr.aria-label]="'Taux de r√©ussite: ' + (statistiques.tauxReussite | number:'1.0-0') + '%'">
            {{ statistiques.tauxReussite | number:'1.0-0' }}%
          </p>
          <p class="stat-label">Taux de R√©ussite</p>
        </div>
      </article>
      
      <article class="stat-card stat-temps" role="listitem">
        <div class="stat-icon" aria-hidden="true">‚è±Ô∏è</div>
        <div class="stat-content">
          <p class="stat-value" [attr.aria-label]="'Temps total: ' + formatTemps(statistiques.tempsTotalMinutes)">
            {{ formatTemps(statistiques.tempsTotalMinutes) }}
          </p>
          <p class="stat-label">Temps Total</p>
        </div>
      </article>
    </div>
  </section>

  <!-- ========== STATS PAR √âTAT ========== -->
  <section class="stats-section" aria-labelledby="stats-etat-title">
    <h2 id="stats-etat-title" class="sr-only">Statistiques par √©tat</h2>
    <div class="stats-cards-container" role="list">
      <article class="stat-card stat-en-attente" role="listitem" *ngIf="stats.enAttente > 0">
        <div class="stat-icon" aria-hidden="true">‚è≥</div>
        <div class="stat-content">
          <p class="stat-value" [attr.aria-label]="'En attente: ' + stats.enAttente">
            {{ stats.enAttente }}
          </p>
          <p class="stat-label">En Attente</p>
        </div>
      </article>
      
      <article class="stat-card stat-en-cours" role="listitem" *ngIf="stats.enCours > 0">
        <div class="stat-icon" aria-hidden="true">üîß</div>
        <div class="stat-content">
          <p class="stat-value" [attr.aria-label]="'En cours: ' + stats.enCours">
            {{ stats.enCours }}
          </p>
          <p class="stat-label">En Cours</p>
        </div>
      </article>
      
      <article class="stat-card stat-terminee" role="listitem" *ngIf="stats.terminees > 0">
        <div class="stat-icon" aria-hidden="true">‚úÖ</div>
        <div class="stat-content">
          <p class="stat-value" [attr.aria-label]="'Termin√©es: ' + stats.terminees">
            {{ stats.terminees }}
          </p>
          <p class="stat-label">Termin√©es</p>
        </div>
      </article>
      
      <article class="stat-card stat-suspendue" role="listitem" *ngIf="stats.suspendues > 0">
        <div class="stat-icon" aria-hidden="true">‚è∏Ô∏è</div>
        <div class="stat-content">
          <p class="stat-value" [attr.aria-label]="'Suspendues: ' + stats.suspendues">
            {{ stats.suspendues }}
          </p>
          <p class="stat-label">Suspendues</p>
        </div>
      </article>
    </div>
  </section>

  <!-- ========== FILTRES ET RECHERCHE ========== -->
  <section class="filters-section" aria-labelledby="filters-title">
    <div class="section-title">
      <h2 id="filters-title">üîç Recherche et Filtres</h2>
    </div>
    <div class="filters-grid">
      <div class="search-box">
        <label for="search-input" class="sr-only">Rechercher une intervention</label>
        <input 
          id="search-input"
          type="text" 
          [(ngModel)]="recherche" 
          (input)="appliquerFiltres()"
          placeholder="Rechercher par description, ID, type..."
          [attr.aria-label]="'Rechercher une intervention'"
          autocomplete="off">
      </div>
      
      <div>
        <label for="filter-etat" class="sr-only">Filtrer par √©tat</label>
        <select 
          id="filter-etat"
          [(ngModel)]="filtreEtat" 
          (change)="loadMyInterventions()"
          [attr.aria-label]="'Filtrer par √©tat'">
          <option value="">Tous les √©tats</option>
          <option value="EN_ATTENTE">‚è≥ En attente</option>
          <option value="EN_COURS">üîß En cours</option>
          <option value="TERMINEE">‚úÖ Termin√©e</option>
          <option value="SUSPENDUE">‚è∏Ô∏è Suspendue</option>
        </select>
      </div>
    </div>
  </section>

  <!-- ========== LISTE DES INTERVENTIONS ========== -->
  <section class="interventions-section" aria-labelledby="interventions-title">
    <div class="section-title">
      <h2 id="interventions-title">üìã Mes Interventions</h2>
      <span class="count-badge" [attr.aria-label]="'Nombre d\'interventions: ' + interventionsFiltrees.length">
        {{ interventionsFiltrees.length }} intervention(s)
      </span>
    </div>

    <!-- √âtat de chargement -->
    <div *ngIf="loading" class="loading-state" role="status" aria-live="polite">
      <p>Chargement des interventions...</p>
    </div>

    <!-- √âtat vide -->
    <div *ngIf="!loading && interventionsFiltrees.length === 0" class="empty-state" role="status">
      <p aria-live="polite">üì≠ Aucune intervention trouv√©e</p>
      <p class="empty-subtitle">
        <span *ngIf="recherche || filtreEtat">
          Aucune intervention ne correspond √† vos crit√®res de recherche.
        </span>
        <span *ngIf="!recherche && !filtreEtat">
          Vous n'avez pas encore d'interventions assign√©es.
        </span>
      </p>
    </div>

    <!-- Liste des interventions -->
    <div *ngIf="!loading && interventionsFiltrees.length > 0" class="interventions-list" role="list">
      <article 
        *ngFor="let intervention of interventionsFiltrees; trackBy: trackByInterventionId" 
        class="intervention-card"
        role="listitem"
        [attr.aria-label]="'Intervention ' + intervention.id + ': ' + (intervention.description || 'Sans description')"
        tabindex="0">
        
        <div class="card-header">
          <div class="card-title">
            <span class="intervention-id" aria-label="Num√©ro d'intervention">#{{ intervention.id }}</span>
            <h3>{{ intervention.description || 'Sans description' }}</h3>
          </div>
          <div class="card-badges" role="group" aria-label="Badges d'√©tat et priorit√©">
            <span [class]="getEtatClass(intervention.etat)" class="badge" [attr.aria-label]="'√âtat: ' + getEtatLabel(intervention.etat)">
              {{ getEtatLabel(intervention.etat) }}
            </span>
            <span [class]="getPrioriteClass(intervention.priorite)" class="badge" [attr.aria-label]="'Priorit√©: ' + getPrioriteLabel(intervention.priorite)">
              {{ getPrioriteLabel(intervention.priorite) }}
            </span>
          </div>
        </div>
        
        <div class="card-body">
          <div class="info-row">
            <div class="info-item" *ngIf="intervention.typeIntervention">
              <strong>Type:</strong> 
              <span>{{ intervention.typeIntervention }}</span>
            </div>
            <div class="info-item" *ngIf="intervention.datePlanifiee">
              <strong>Date pr√©vue:</strong> 
              <time [attr.datetime]="intervention.datePlanifiee">
                {{ intervention.datePlanifiee | date:'dd/MM/yyyy' }}
              </time>
            </div>
            <div class="info-item" *ngIf="intervention.tempsPasseMinutes">
              <strong>Temps pass√©:</strong> 
              <span>{{ formatTemps(intervention.tempsPasseMinutes) }}</span>
            </div>
          </div>
          
          <div class="info-row" *ngIf="intervention.mainDOeuvreIds && intervention.mainDOeuvreIds.length > 0">
            <div class="info-item">
              <strong>Agents affect√©s:</strong> 
              <span>{{ intervention.mainDOeuvreIds.length }}</span>
            </div>
          </div>
        </div>

        <!-- T√¢ches assign√©es -->
        <div class="taches-section-card" *ngIf="getTachesForIntervention(intervention.id).length > 0" 
             (click)="$event.stopPropagation()">
          <h4>üìã Mes T√¢ches</h4>
          <div class="taches-list-card" role="list">
            <div 
              *ngFor="let tache of getTachesForIntervention(intervention.id); trackBy: trackByTacheId" 
              class="tache-item-card"
              [class]="getEtatTacheClass(tache.etat)"
              role="listitem"
              [attr.aria-label]="'T√¢che: ' + tache.libelle + ', √âtat: ' + getEtatTacheLabel(tache.etat)">
              
              <!-- Barre de progression d'√©tat professionnelle -->
              <div class="tache-progress-bar" role="progressbar" 
                   [attr.aria-valuenow]="getEtatProgress(tache.etat)"
                   aria-valuemin="0"
                   aria-valuemax="100"
                   [attr.aria-label]="'Progression de la t√¢che: ' + getEtatProgress(tache.etat) + '%'">
                <div class="progress-track">
                  <div class="progress-fill" [style.width.%]="getEtatProgress(tache.etat)"></div>
                </div>
                <div class="progress-steps">
                  <div class="progress-step" 
                       [class.active]="isEtatActive(tache.etat, 'A_FAIRE')"
                       [class.completed]="isEtatCompleted(tache.etat, 'A_FAIRE')">
                    <div class="step-indicator">
                      <svg *ngIf="isEtatCompleted(tache.etat, 'A_FAIRE')" class="step-check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <span *ngIf="!isEtatCompleted(tache.etat, 'A_FAIRE')" class="step-number">1</span>
                    </div>
                    <span class="step-label">√Ä faire</span>
                  </div>
                  <div class="progress-line" 
                       [class.completed]="isEtatCompleted(tache.etat, 'EN_COURS')"></div>
                  <div class="progress-step"
                       [class.active]="isEtatActive(tache.etat, 'EN_COURS')"
                       [class.completed]="isEtatCompleted(tache.etat, 'EN_COURS')">
                    <div class="step-indicator">
                      <svg *ngIf="isEtatCompleted(tache.etat, 'EN_COURS')" class="step-check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <span *ngIf="!isEtatCompleted(tache.etat, 'EN_COURS')" class="step-number">2</span>
                    </div>
                    <span class="step-label">En cours</span>
                  </div>
                  <div class="progress-line"
                       [class.completed]="isEtatCompleted(tache.etat, 'TERMINEE')"></div>
                  <div class="progress-step"
                       [class.active]="isEtatActive(tache.etat, 'TERMINEE')"
                       [class.completed]="isEtatCompleted(tache.etat, 'TERMINEE')">
                    <div class="step-indicator">
                      <svg *ngIf="isEtatCompleted(tache.etat, 'TERMINEE')" class="step-check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <span *ngIf="!isEtatCompleted(tache.etat, 'TERMINEE')" class="step-number">3</span>
                    </div>
                    <span class="step-label">Termin√©e</span>
                  </div>
                  <div class="progress-line"
                       [class.completed]="isEtatCompleted(tache.etat, 'VERIFIEE')"></div>
                  <div class="progress-step"
                       [class.active]="isEtatActive(tache.etat, 'VERIFIEE')"
                       [class.completed]="isEtatCompleted(tache.etat, 'VERIFIEE')">
                    <div class="step-indicator">
                      <svg *ngIf="isEtatCompleted(tache.etat, 'VERIFIEE')" class="step-check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <span *ngIf="!isEtatCompleted(tache.etat, 'VERIFIEE')" class="step-number">4</span>
                    </div>
                    <span class="step-label">V√©rifi√©e</span>
                  </div>
                </div>
              </div>
              
              <div class="tache-item-header">
                <span class="tache-libelle">{{ tache.libelle }}</span>
                <span class="badge-tache" [class]="getEtatTacheClass(tache.etat)" 
                      [attr.aria-label]="'√âtat de la t√¢che: ' + getEtatTacheLabel(tache.etat)">
                  {{ getEtatTacheLabel(tache.etat) }}
                </span>
              </div>
              
              <div class="tache-item-description" *ngIf="tache.description">
                <p>{{ tache.description }}</p>
              </div>
              
              <div class="tache-item-actions" *ngIf="tache.etat === 'A_FAIRE' || tache.etat === 'EN_COURS'">
                <button 
                  *ngIf="tache.etat === 'A_FAIRE'"
                  type="button"
                  class="btn-commencer"
                  (click)="commencerTache(tache)"
                  [attr.aria-label]="'Commencer la t√¢che: ' + tache.libelle">
                  <span aria-hidden="true">‚ñ∂Ô∏è</span>
                  <span>Commencer</span>
                </button>
                <button 
                  *ngIf="tache.etat === 'EN_COURS'"
                  type="button"
                  class="btn-terminer"
                  (click)="ouvrirTerminerTache(tache)"
                  [attr.aria-label]="'Terminer la t√¢che: ' + tache.libelle">
                  <span aria-hidden="true">‚úÖ</span>
                  <span>Terminer</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-footer">
          <button 
            type="button"
            class="btn-view-details"
            (click)="voirDetails(intervention.id, $event); $event.stopPropagation()"
            [attr.aria-label]="'Voir les d√©tails de l\'intervention ' + intervention.id">
            Voir les d√©tails
            <span aria-hidden="true">‚Üí</span>
          </button>
        </div>
      </article>
    </div>
  </section>

  <!-- ========== MODAL TERMINER T√ÇCHE ========== -->
  <div *ngIf="selectedTacheForTerminer" 
       class="modal-terminer-tache"
       role="dialog"
       aria-labelledby="modal-title"
       aria-modal="true"
       (click)="selectedTacheForTerminer = null">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3 id="modal-title">Terminer la t√¢che: {{ selectedTacheForTerminer.libelle }}</h3>
      <form (ngSubmit)="terminerTache()" [attr.aria-label]="'Formulaire pour terminer la t√¢che'">
        <div class="form-group">
          <label for="commentaire">Commentaire (optionnel)</label>
          <textarea 
            id="commentaire"
            [(ngModel)]="terminerTacheRequest.commentaire" 
            name="commentaire"
            placeholder="Ajoutez un commentaire sur le travail effectu√©..."
            rows="4"
            [attr.aria-describedby]="'commentaire-help'"></textarea>
          <small id="commentaire-help" class="form-help">
            D√©crivez bri√®vement le travail effectu√© ou les observations importantes.
          </small>
        </div>
        <div class="form-group">
          <label for="temps-passe">Temps pass√© (en minutes, optionnel)</label>
          <input 
            id="temps-passe"
            type="number" 
            [(ngModel)]="terminerTacheRequest.tempsPasseMinutes" 
            name="tempsPasseMinutes"
            placeholder="Ex: 120"
            min="0"
            step="1"
            [attr.aria-describedby]="'temps-help'">
          <small id="temps-help" class="form-help">
            Indiquez le temps r√©ellement pass√© sur cette t√¢che en minutes.
          </small>
        </div>
        <div class="modal-actions">
          <button 
            type="button"
            class="btn-secondary" 
            (click)="selectedTacheForTerminer = null"
            [attr.aria-label]="'Annuler'">
            Annuler
          </button>
          <button 
            type="submit"
            class="btn-success" 
            [attr.aria-label]="'Confirmer la terminaison de la t√¢che'">
            <span aria-hidden="true">‚úÖ</span>
            <span>Terminer</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Styles pour l'accessibilit√© (screen readers) -->
<style>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
  
  .form-help {
    display: block;
    margin-top: var(--space-1);
    font-size: var(--text-xs);
    color: var(--neutral-600);
  }
  
  .tache-item-description {
    margin-bottom: var(--space-3);
  }
  
  .tache-item-description p {
    font-size: var(--text-sm);
    color: var(--neutral-700);
    margin: 0;
    line-height: 1.5;
  }
</style>
